# 宮干四化完整指南

## 📚 目錄

1. [什麼是宮干四化](#什麼是宮干四化)
2. [四化表對照](#四化表對照)
3. [自化與飛化](#自化與飛化)
4. [系統實現](#系統實現)
5. [使用方法](#使用方法)
6. [命理意義](#命理意義)
7. [常見格局](#常見格局)

---

## 什麼是宮干四化

**宮干四化**是紫微斗數中極為重要的推斷技法，是透過每個宮位的**天干**（宮干）來引發特定星曜產生「化祿、化權、化科、化忌」四種變化。

### 基本概念

- **宮干**：每個宮位都有其對應的天干（甲、乙、丙、丁、戊、己、庚、辛、壬、癸）
- **四化**：
  - **化祿**：財祿、緣分、喜悅
  - **化權**：權力、掌控、主動
  - **化科**：名聲、貴人、考試
  - **化忌**：阻礙、執著、煩惱

### 三種四化類型

1. **生年四化（本命四化）**：根據出生年的天干產生的四化
2. **宮干自化**：宮干化出的四化星在本宮內
3. **宮干飛化**：宮干化出的四化星飛入其他宮位

---

## 四化表對照

| 天干 | 化祿 | 化權 | 化科 | 化忌 |
|------|------|------|------|------|
| 甲 | 廉貞 | 破軍 | 武曲 | 太陽 |
| 乙 | 天機 | 天梁 | 紫微 | 太陰 |
| 丙 | 天同 | 天機 | 文昌 | 廉貞 |
| 丁 | 太陰 | 天同 | 天機 | 巨門 |
| 戊 | 貪狼 | 太陰 | 右弼 | 天機 |
| 己 | 武曲 | 貪狼 | 天梁 | 文曲 |
| 庚 | 太陽 | 武曲 | 太陰 | 天同 |
| 辛 | 巨門 | 太陽 | 文曲 | 文昌 |
| 壬 | 天梁 | 紫微 | 左輔 | 武曲 |
| 癸 | 破軍 | 巨門 | 太陰 | 貪狼 |

---

## 自化與飛化

### 自化（Self Transformation）

當某宮的宮干化出的星曜**恰好在本宮內**，稱為自化。

**示例**：
- 命宮宮干為「甲」，命宮內有「廉貞星」→ 廉貞自化祿

**命理意義**：
- **自化祿**：自給自足，主動求財，但財來財去
- **自化權**：自我要求高，獨立自主
- **自化科**：自我學習，重視名聲
- **自化忌**：自我困擾，鑽牛角尖

### 飛化（Flying Transformation）

當某宮的宮干化出的星曜**飛入其他宮位**，稱為飛化。

**示例**：
- 命宮宮干為「甲」，財帛宮有「廉貞星」→ 命宮化祿飛入財帛宮

**命理意義**：
- 表示命主（我）對財帛宮（錢財）的態度與緣分
- 命宮化祿入財帛：主動求財，財運亨通

### 來化（Incoming Transformation）

從另一個角度看飛化，即**其他宮位的化星飛入本宮**。

**示例**：
- 財帛宮宮干化祿飛入命宮 → 從財帛宮來看是「飛出」，從命宮來看是「來化」

---

## 系統實現

### 資料結構

```python
# 宮位類別
class Palace:
    def __init__(self, index, name_key, stem="", branch=""):
        self.stem = stem  # 宮干（天干）
        self.stars = []   # 宮內星曜列表

# 星曜類別
class Star:
    def __init__(self, name_key, transformation=None):
        self.key = name_key
        self.transformation = transformation  # 生年四化
```

### 檢測邏輯

#### 1. 自化檢測（rule_engine.py 第 386-395 行）

```python
if "self_trans" in condition:
    req_trans = condition["self_trans"]  # 要求的四化類型（如 "hua_lu"）
    stem = palace.stem  # 宮干
    if stem in SI_HUA_TABLE:
        star_key = SI_HUA_TABLE[stem].get(req_trans)  # 查表獲取化星
        if star_key:
            if not palace.has_star(star_key): 
                return False  # 該星不在宮內，非自化
```

#### 2. 飛化檢測（rule_engine.py 第 397-410 行）

```python
if "flying_from" in condition and "trans" in condition:
    source_key = condition["flying_from"]  # 來源宮位
    req_trans = condition["trans"]  # 四化類型
    source_palace = chart.get_palace(source_key)
    if source_palace:
        stem = source_palace.stem  # 來源宮的宮干
        if stem in SI_HUA_TABLE:
            star_key = SI_HUA_TABLE[stem].get(req_trans)
            if star_key:
                if not palace.has_star(star_key): 
                    return False  # 化星未飛入本宮
```

---

## 使用方法

### 方法一：使用規則引擎

在 `ziwei_rules.json` 中定義規則：

```json
{
  "id": "SH10001",
  "category": "life",
  "description": "命宮廉貞自化祿",
  "conditions": {
    "logic": "AND",
    "criteria": [
      {"target": "life", "has_star": "lian_zhen"},
      {"target": "life", "self_trans": "hua_lu"}
    ]
  },
  "result": {
    "text": "命宮廉貞自化祿：主動求財，但宜小心桃花糾紛...",
    "tags": ["宮干四化", "自化祿"]
  }
}
```

### 方法二：使用分析工具

```python
from analyze_sihua import analyze_chart_sihua, print_sihua_report
from rule_engine import create_chart_from_dict

# 從前端獲取命盤數據
chart = create_chart_from_dict(chart_data, gender="M")

# 分析四化
results = analyze_chart_sihua(chart)

# 打印報告
print_sihua_report(results)
```

### 方法三：自動生成規則

```bash
# 執行規則生成器
python generate_sihua_rules.py
```

這會自動生成：
- 10 條主星自化祿規則
- 8 條重要飛化規則
- 8 條組合格局規則（雙祿、祿馬交馳等）

---

## 命理意義

### 化祿的命理意義

| 飛化路徑 | 命理解釋 |
|----------|----------|
| 命宮 → 財帛宮 | 主動求財，一生與金錢有緣 |
| 命宮 → 事業宮 | 事業心強，工作積極 |
| 命宮 → 夫妻宮 | 重視感情，婚姻幸福 |
| 命宮 → 遷移宮 | 外出有利，他鄉得財 |
| 財帛宮 → 命宮 | 財來就我，不勞而獲 |
| 事業宮 → 命宮 | 事業回饋，名利雙收 |
| 夫妻宮 → 命宮 | 配偶助力，因婚得福 |
| 父母宮 → 命宮 | 祖蔭豐厚，長輩提攜 |

### 自化祿的特性

- **優點**：自給自足，獨立能力強，主動積極
- **缺點**：財來財去，不易守成，容易變動
- **適合**：業務、銷售、自由業、創業

### 化祿組合格局

1. **雙祿格**：祿存 + 化祿同宮
   - 財運極佳，福氣深厚

2. **祿馬交馳**：化祿 + 天馬同宮
   - 動中生財，適合貿易、運輸

3. **祿權同宮**：化祿 + 化權同宮
   - 財權雙收，掌握資源

4. **祿科同宮**：化祿 + 化科同宮
   - 名利雙全，聲譽卓著

---

## 常見格局

### 吉格

1. **財祿夾命**：財帛宮與福德宮的化祿夾命宮
2. **祿入廟旺**：化祿星在廟旺位置
3. **三方會祿**：命、財、官三方都有化祿

### 需注意格局

1. **自化祿空亡**：自化祿遇地空地劫
2. **祿忌相沖**：化祿與化忌在對宮相沖
3. **祿入陷地**：化祿星在不利位置

---

## 工具文件說明

### 1. `analyze_sihua.py` - 四化分析工具
**功能**：
- 分析整張命盤的四化情況
- 列出所有自化、飛化、來化
- 生成詳細報告

**使用**：
```bash
python analyze_sihua.py
```

### 2. `generate_sihua_rules.py` - 規則生成器
**功能**：
- 自動生成化祿相關規則
- 添加到規則庫
- 包含自化、飛化、格局規則

**使用**：
```bash
python generate_sihua_rules.py
```

### 3. `rule_engine.py` - 規則引擎
**功能**：
- 核心邏輯引擎
- 支援 `self_trans` 和 `flying_from` 判斷
- 評估命盤符合哪些規則

---

## 進階應用

### 流年四化

除了命盤的宮干四化，流年也有四化：
- 流年天干的四化會影響當年運勢
- 流年四化與命盤四化的交互作用

### 大限四化

每個大限都有其宮干四化：
- 大限宮的宮干決定該十年的四化
- 影響該十年的運勢走向

### 小限四化

每年的小限宮也有四化：
- 小限宮的宮干影響當年細節
- 與流年四化配合觀察

---

## 注意事項

1. **宮干必須正確**：四化的準確性依賴於宮干的正確性
2. **星曜必須在宮**：只有宮內有該星曜，才能產生四化效應
3. **綜合判斷**：四化需要配合星曜本質、宮位意義綜合判斷
4. **避免過度解讀**：四化是輔助工具，不能單獨論斷

---

## 參考資料

- 《紫微斗數全書》
- 《飛星紫微斗數》
- 《紫微四化精論》
- 系統文件：`rule_engine.py`

---

**版本**：1.0  
**最後更新**：2026-02-05  
**作者**：FatePurple 團隊
