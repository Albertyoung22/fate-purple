<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>éœéŸ³å»£æ’­æ§åˆ¶å°</title>
    <script defer src="auth.js"></script>
    <style>
        :root {
            --bg: #f5f8fb;
            --card: #ffffff;
            --border: #d9e8fb;
            --text: #0f172a;
            --muted: #5a6b80;
            --primary: #1e7bd8;
            --primary-dark: #165ea3;
            --success: #0a8754;
            --warn: #e38b06;
            --danger: #d62839;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, "Microsoft JhengHei", Segoe UI, Roboto, Arial;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            padding: 12px 16px;
            background: var(--primary);
            color: #fff;
        }

        header .links {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 14px;
        }

        header .links a {
            color: #dff1ff;
            text-decoration: none;
        }

        header .links a:hover {
            text-decoration: underline;
        }

        header .links .sep {
            color: rgba(255, 255, 255, 0.4);
            margin: 0 2px 0 10px;
            font-size: 11px;
        }

        .wrap {
            max-width: 1240px;
            margin: 0 auto;
            padding: 16px;
            display: grid;
            grid-template-columns: 1fr 1.1fr;
            gap: 18px;
        }

        @media (max-width: 960px) {
            .wrap {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 6px 24px rgba(15, 23, 42, .08);
        }

        .card h2 {
            margin: 0 0 12px 0;
            font-size: 18px;
        }

        textarea,
        input,
        select {
            width: 100%;
            background: #fff;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 14px;
            outline: none;
        }

        textarea {
            min-height: 110px;
            resize: vertical;
        }

        .btn {
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            color: #fff;
            background: var(--primary);
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.3px;
            transition: transform .1s ease, filter .1s ease;
        }

        .btn:hover {
            filter: brightness(1.05);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn.secondary {
            background: #eef4ff;
            color: var(--primary-dark);
            border: 1px solid var(--border);
        }

        .btn.warn {
            background: var(--warn);
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 6px;
        }

        .row {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .btn.danger {
            background: var(--danger);
        }

        .muted {
            color: var(--muted);
            font-size: 13px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border);
            text-align: left;
            font-size: 14px;
        }

        th {
            background: #f1f5ff;
            color: var(--muted);
            font-weight: 600;
        }

        .client-table th,
        .client-table td {
            font-size: 12px;
        }

        tr:hover td {
            background: #f8fbff;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(255, 255, 255, .2);
            border: 1px solid rgba(255, 255, 255, .4);
            color: #fff;
            font-size: 13px;
        }

        .status {
            min-height: 18px;
            font-size: 13px;
            color: var(--muted);
            margin-top: 8px;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .ann-panel {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
            margin: 14px 0;
            box-shadow: 0 4px 16px rgba(15, 23, 42, .06);
        }

        .ann-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .ann-text {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            background: #fff;
            color: var(--text);
        }

        .ann-btn {
            appearance: none;
            border: 0;
            background: var(--primary);
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: transform .08s ease, filter .08s ease;
        }

        .ann-btn:hover {
            filter: brightness(1.08);
        }

        .ann-btn:active {
            transform: translateY(1px);
        }

        .ann-btn.warn {
            background: var(--warn);
        }

        .ann-btn.secondary {
            background: var(--success);
        }

        .ann-muted {
            color: var(--muted);
            font-size: 13px;
        }

        .ann-preview {
            max-width: 320px;
            max-height: 180px;
            border-radius: 10px;
            display: block;
            margin-top: 8px;
            border: 1px solid var(--border);
        }

        .ann-toggle {
            margin: 12px 0;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
            transition: background .12s ease;
        }

        .ann-toggle:hover {
            background: rgba(30, 123, 216, .12);
        }

        .ann-hidden {
            display: none;
        }
    </style>
</head>

<body>

    <header>
        <div>
            <div class="pill">ç„¡è²çœ‹æ¿ Â· Silent Cast</div>
            <div class="muted" id="summary">æ­£åœ¨è¼‰å…¥...</div>
        </div>
        <div class="links">
            <span id="nowText"
                style="margin-right:12px;opacity:.85;display:inline-block;min-width:110px;text-align:right">--:--:--</span>
            <a href="index.html">ğŸ› ä¸»æ§å°</a>
            <a href="sched.html">ğŸ• æ’ç¨‹</a>
            <a href="single_reservation.html">ğŸ“… é ç´„</a>
            <a href="tt.html">ğŸ“š èª²è¡¨</a>
            <span class="sep">|</span>
            <a href="taigi_edu.html">ğŸ‡¹ğŸ‡¼ æœ¬åœŸèª</a>
            <a href="eew.html">ğŸŒ‹ åœ°éœ‡</a>
            <a href="relay4.html">ğŸ“£ åˆ†å€</a>
            <a href="silent-dashboard.html">ğŸ”‡ ç„¡è²</a>
            <span class="sep">|</span>
            <a href="broadcast.html" target="_blank">ğŸ™ï¸ è¡Œå‹•</a>
            <a href="live.html">ğŸ”´ ç›´æ’­</a>
            <a href="teacher_call.html" target="_blank">ğŸ“¹ é€šè©±</a>
            <span class="sep">|</span>
            <a href="/teacher?key=teacher" target="_blank">ğŸµ åª’é«”</a>
            <a href="logs.html">ğŸ—’ ç´€éŒ„</a>
        </div>
        <div class="row">
            <button class="btn secondary btn-sm" onclick="refreshClients()">åˆ·æ–°</button>
            <button class="btn secondary btn-sm" onclick="autoRefreshToggle()" id="autoBtn">è‡ªå‹•:é–‹</button>
        </div>
    </header>

    <div class="wrap">
        <section class="card">
            <div class="ann-panel">
                <div class="ann-toggle" id="annToggle">
                    <span style="font-weight:700">éœéŸ³å»£æ’­</span>
                    <a href="/static/ui/announce.html" target="_blank" onclick="event.stopPropagation()"
                        style="text-decoration:none;margin:0 4px;" title="é–‹å•Ÿå…¬å‘Šçœ‹æ¿">ğŸ”—</a>
                    <span class="ann-muted">å¡«å…¥æ–‡å­—ã€ä¸Šå‚³åœ–ç‰‡/å½±éŸ³å¾Œé€å‡ºè‡³ announce.html</span>
                </div>
                <div id="annBody">
                    <label class="ann-muted">å»£æ’­æ–‡å­—</label>
                    <textarea id="annMsg" class="ann-text" placeholder="ä¾‹å¦‚ï¼š302 ç­åˆ°å¤§ç¦®å ‚é›†åˆ"></textarea>
                    <div class="ann-row">
                        <input id="annFile" type="file" accept="image/*" />
                        <button id="annUpload" class="ann-btn secondary">ä¸Šå‚³åœ–ç‰‡</button>
                        <span id="annImgUrl" class="ann-muted"></span>
                    </div>
                    <div class="ann-row">
                        <input id="annMediaFile" type="file" accept="audio/*,video/*" />
                        <button id="annMediaUpload" class="ann-btn secondary">ä¸Šå‚³éŸ³è¨Š/å½±ç‰‡</button>
                        <span id="annMediaUrl" class="ann-muted"></span>
                    </div>
                    <img id="annPreview" class="ann-preview" style="display:none" />
                    <div class="ann-row">
                        <button id="annSendSound" class="ann-btn">é€å‡ºï¼ˆæœ—è®€ï¼‰</button>
                        <button id="annSendSilent" class="ann-btn warn">é€å‡ºï¼ˆç„¡è²ï¼‰</button>
                        <span id="annStatus" class="ann-muted">æº–å‚™</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="card">
            <h2>å­¸ç”Ÿç«¯è¨­å‚™ç‹€æ³èˆ‡æ§åˆ¶</h2>
            <div class="row" style="justify-content:space-between; align-items:center;">
                <div class="muted">å·²çŸ¥ <strong id="count">0</strong> å° Â· ä¸Šæ¬¡æ›´æ–° <span id="lastUpdated">--</span></div>
            </div>
            <table class="client-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="chkAll" onchange="toggleAll(this)"></th>
                        <th>Client ID</th>
                        <th>ä¸»æ©Ÿåç¨±</th>
                        <th>IP</th>
                        <th>ç¾¤çµ„</th>
                        <th>MAC</th>
                        <th>ç‹€æ…‹</th>
                        <th>æœ€å¾Œä¸Šç·š</th>
                    </tr>
                </thead>
                <tbody id="clientBody">
                    <tr>
                        <td colspan="8" class="muted">è¼‰å…¥ä¸­...</td>
                    </tr>
                </tbody>
            </table>

            <!-- æœ€çµ‚ç‰ˆå¿«é€ŸæŒ‡ä»¤å€ï¼šè‡ªå‹•åµæ¸¬å¾Œç«¯ IP -->
            <div
                style="margin-top:16px; padding:16px; background:#ffffff; border:1px solid var(--border); border-radius:14px; box-shadow:0 8px 24px rgba(15,23,42,.08);">
                <div style="margin-bottom:12px;">
                    <strong>å¿«é€Ÿä¸€éµæŒ‡ä»¤ï¼ˆç›´æ¥å°å‹¾é¸çš„é›»è…¦åŸ·è¡Œï¼‰</strong>
                </div>

                <div class="actions" style="gap:12px; flex-wrap:wrap;">
                    <div
                        style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; width:100%; margin-bottom:8px;">
                        <input type="text" id="quickUrl" placeholder="ç•™ç©º = è‡ªå‹•é–‹å•Ÿç›®å‰å¾Œç«¯çš„éœéŸ³å»£æ’­é ï¼ˆannounce.htmlï¼‰"
                            style="flex:1; min-width:280px;" value="">
                        <button class="btn" onclick="quickOpenUrl()">é–‹å•Ÿç¶²å€</button>
                        <button class="btn secondary" onclick="quickOpenUrl(true)">ä¸€éµéœéŸ³å»£æ’­</button>
                        <button class="btn secondary" onclick="quickOpenWatch()"
                            style="background:#e83e8c;color:#fff;border-color:#e83e8c;">ä¸€éµé–‹å•Ÿç›´æ’­</button>
                    </div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap; width:100%; margin-bottom:8px;">
                        <button class="btn secondary" onclick="quickOpenGroup(1)">ç¾¤çµ„ 1</button>
                        <button class="btn secondary" onclick="quickOpenGroup(2)">ç¾¤çµ„ 2</button>
                        <button class="btn secondary" onclick="quickOpenGroup(3)">ç¾¤çµ„ 3</button>
                        <button class="btn secondary" onclick="quickOpenGroup(4)">ç¾¤çµ„ 4</button>
                        <button class="btn secondary" onclick="quickOpenGroup(5)">ç¾¤çµ„ 5</button>
                        <button class="btn secondary" onclick="quickOpenGroup(6)">ç¾¤çµ„ 6</button>
                    </div>

                    <button class="btn secondary" onclick="quickCmd('lock')">é–å®šè¢å¹•</button>
                    <button class="btn warn" onclick="quickCmd('shutdown')">ç«‹å³é—œæ©Ÿ</button>
                    <button class="btn warn" onclick="quickCmd('reboot')">é‡æ–°é–‹æ©Ÿ</button>
                    <button class="btn secondary" onclick="quickCmd('ring')"
                        style="background:#fde68a;color:#92400e;border-color:#f59e0b;">éŸ¿éˆ´</button>
                    <button class="btn secondary" onclick="quickCmd('wol')">ç¶²è·¯å–šé†’ï¼ˆWOLï¼‰</button>

                    <div style="margin-top:12px; width:100%; display:flex; gap:8px;">
                        <button class="btn secondary" onclick="selectAll()">å…¨é¸</button>
                        <button class="btn secondary" onclick="clearAll()">å…¨éƒ¨å–æ¶ˆ</button>
                        <button class="btn secondary" onclick="refreshClients()">åˆ·æ–°åå–®</button>
                    </div>
                </div>

                <div class="status" id="quickStatus" style="margin-top:12px;"></div>
            </div>

            <div class="status" id="clientStatus"></div>
        </section>
    </div>

    <script>
        const el = (id) => document.getElementById(id);

        let state = {
            clients: {},
            selectedIds: new Set(),
            auto: true,
        };

        function startClock() {
            function pad(n) { return n.toString().padStart(2, "0"); }
            function fmt(date) { return `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`; }
            function tick() { el("nowText").textContent = fmt(new Date()); }
            tick();
            setInterval(tick, 1000);
        }

        function toggleAll(checkbox) {
            const checked = checkbox.checked;
            document.querySelectorAll('input[name="targets"]').forEach(cb => {
                cb.checked = checked;
                checked ? state.selectedIds.add(cb.value) : state.selectedIds.delete(cb.value);
            });
        }

        function renderClients() {
            const body = el("clientBody");
            const entries = Object.entries(state.clients || {});

            if (entries.length === 0) {
                body.innerHTML = '<tr><td colspan="8" class="muted">æš«ç„¡å­¸ç”Ÿç«¯é€£ç·š</td></tr>';
                el("chkAll").checked = false;
                return;
            }

            let html = '';
            for (const [cid, c] of entries) {
                const statusText = c.online ? 'ç·šä¸Š' : '<span class="muted">é›¢ç·š</span>';
                const isChecked = state.selectedIds.has(cid) ? 'checked' : '';
                html += `<tr>
                <td><input type="checkbox" name="targets" value="${cid}" ${isChecked} onchange="handleCheckbox(this)"></td>
                <td>${cid}</td>
                <td>${c.hostname || '--'}</td>
                <td>${c.ip || '--'}</td>
                <td>${c.group || 'default'}</td>
                <td>${c.mac || '--'}</td>
                <td>${statusText}</td>
                <td>${c.last_seen_str || '--'}</td>
            </tr>`;
            }
            body.innerHTML = html;

            const total = entries.length;
            const selected = state.selectedIds.size;
            const chkAll = el("chkAll");
            chkAll.checked = selected > 0 && selected === total;
            chkAll.indeterminate = selected > 0 && selected < total;
        }

        function handleCheckbox(cb) {
            cb.checked ? state.selectedIds.add(cb.value) : state.selectedIds.delete(cb.value);
            renderClients();
        }

        async function refreshClients() {
            try {
                const resp = await fetch('/controller/api/clients_v2');
                const data = await resp.json();
                if (!data.ok) { el("clientStatus").textContent = "éŒ¯èª¤ï¼š" + (data.error || "ç„¡æ³•ç²å–åˆ—è¡¨"); return; }

                state.clients = data.clients || {};
                const onlineCount = data.online_count || 0;
                el("count").textContent = Object.keys(state.clients).length;
                el("lastUpdated").textContent = new Date().toLocaleTimeString();
                el("summary").textContent = `åœ¨ç·šï¼š${onlineCount} / ${Object.keys(state.clients).length}`;
                renderClients();
                el("clientStatus").textContent = "";
            } catch (e) {
                el("clientStatus").textContent = "åˆ·æ–°å¤±æ•—ï¼š" + e.message;
            }
        }

        function selectAll() { el("chkAll").checked = true; toggleAll(el("chkAll")); }
        function clearAll() { state.selectedIds.clear(); renderClients(); }

        function autoRefreshToggle() {
            state.auto = !state.auto;
            el("autoBtn").textContent = `è‡ªå‹•:${state.auto ? "é–‹" : "é—œ"}`;
        }

        function startAuto() { setInterval(() => { if (state.auto) refreshClients(); }, 7000); }

        // ==================== å¿«é€Ÿä¸€éµæŒ‡ä»¤ ====================
        async function quickCmd(cmd) {
            const targets = Array.from(state.selectedIds);
            if (targets.length === 0) {
                el("quickStatus").textContent = "è«‹å…ˆå‹¾é¸è‡³å°‘ä¸€å°å­¸ç”Ÿç«¯é›»è…¦";
                return;
            }

            el("quickStatus").textContent = "ç™¼é€ä¸­...";
            try {
                const resp = await fetch('/controller/api/send_v2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targets, cmd, url: "" })
                });
                const r = await resp.json();
                if (r.ok) {
                    el("quickStatus").textContent = `å·²å° ${r.count || targets.length} å°ç™¼é€ã€Œ${getCmdName(cmd)}ã€`;
                } else {
                    el("quickStatus").textContent = "å¤±æ•—ï¼š" + (r.error || "");
                }
            } catch (e) {
                el("quickStatus").textContent = "ç™¼é€å¤±æ•—ï¼š" + e.message;
            }
        }

        // é—œéµï¼è‡ªå‹•çµ„æˆç›®å‰å¾Œç«¯çš„ announce.html è·¯å¾‘
        async function quickOpenUrl(useDefault = false) {
            const targets = Array.from(state.selectedIds);
            if (targets.length === 0) {
                el("quickStatus").textContent = "è«‹å…ˆå‹¾é¸è‡³å°‘ä¸€å°å­¸ç”Ÿç«¯é›»è…¦";
                return;
            }

            const baseUrl = window.location.origin;  // è‡ªå‹•å–å¾—ç›®å‰æ§åˆ¶å°çš„ http://IP:Port
            let url = el("quickUrl").value.trim();

            if (!url || useDefault) {
                url = `${baseUrl}/static/ui/announce.html`;  // è‡ªå‹•è£œå®Œæ•´è·¯å¾‘
            }

            el("quickStatus").textContent = "ç™¼é€ä¸­...";
            try {
                const resp = await fetch('/controller/api/send_v2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targets, cmd: "open_url", url })
                });
                const r = await resp.json();
                if (r.ok) {
                    el("quickStatus").textContent = `å·²å° ${r.count || targets.length} å°é–‹å•ŸéœéŸ³å»£æ’­é `;
                } else {
                    el("quickStatus").textContent = "å¤±æ•—ï¼š" + (r.error || "");
                }
            } catch (e) {
                el("quickStatus").textContent = "ç™¼é€å¤±æ•—ï¼š" + e.message;
            }
        }

        async function quickOpenWatch() {
            const targets = Array.from(state.selectedIds);
            if (targets.length === 0) {
                el("quickStatus").textContent = "è«‹å…ˆå‹¾é¸è‡³å°‘ä¸€å°å­¸ç”Ÿç«¯é›»è…¦";
                return;
            }

            const baseUrl = window.location.origin;
            const url = `${baseUrl}/static/ui/watch.html`;

            el("quickStatus").textContent = "ç™¼é€ä¸­ (é–‹å•Ÿç›´æ’­é )...";
            try {
                const resp = await fetch('/controller/api/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targets, cmd: "open_url", url })
                });
                const r = await resp.json();
                if (r.ok) {
                    el("quickStatus").textContent = `å·²å° ${r.count || targets.length} å°é–‹å•Ÿç›´æ’­é `;
                } else {
                    el("quickStatus").textContent = "å¤±æ•—ï¼š" + (r.error || "");
                }
            } catch (e) {
                el("quickStatus").textContent = "ç™¼é€å¤±æ•—ï¼š" + e.message;
            }
        }

        async function quickOpenGroup(groupId) {
            const targets = Array.from(state.selectedIds);
            if (targets.length === 0) {
                el("quickStatus").textContent = "è«‹å…ˆå‹¾é¸è‡³å°‘ä¸€å°å­¸ç”Ÿç«¯é›»è…¦";
                return;
            }

            const url = `${window.location.origin}/g/${groupId}`;

            el("quickStatus").textContent = `ç™¼é€ä¸­ï¼ˆç¾¤çµ„ ${groupId}ï¼‰...`;
            try {
                const resp = await fetch('/controller/api/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targets, cmd: "open_url", url })
                });
                const r = await resp.json();
                if (r.ok) {
                    el("quickStatus").textContent = `å·²å° ${r.count || targets.length} å°é–‹å•Ÿ /g/${groupId}`;
                } else {
                    el("quickStatus").textContent = "å¤±æ•—ï¼š" + (r.error || "");
                }
            } catch (e) {
                el("quickStatus").textContent = "ç™¼é€å¤±æ•—ï¼š" + e.message;
            }
        }

        function getCmdName(cmd) {
            const map = { lock: "é–å®šè¢å¹•", shutdown: "é—œæ©Ÿ", reboot: "é‡æ–°é–‹æ©Ÿ", wol: "ç¶²è·¯å–šé†’", ring: "éŸ¿éˆ´" };
            return map[cmd] || cmd;
        }
        // ==================== å¿«é€ŸæŒ‡ä»¤çµæŸ ====================

        // ==================== éœéŸ³å»£æ’­é¢æ¿ ====================
        (function () {
            const $ = id => document.getElementById(id);
            const body = $('annBody');
            const toggle = $('annToggle');
            toggle?.addEventListener('click', () => body.classList.toggle('ann-hidden'));

            let currentImageUrl = "";
            let currentMediaUrl = "";

            $('annFile')?.addEventListener('change', ev => {
                const f = ev.target.files[0];
                const p = $('annPreview');
                if (!f) { p.style.display = "none"; return; }
                p.src = URL.createObjectURL(f);
                p.style.display = 'block';
            });

            $('annUpload')?.addEventListener('click', async () => {
                const f = $('annFile').files[0];
                if (!f) { $('annStatus').textContent = 'è«‹å…ˆé¸æ“‡åœ–ç‰‡'; return; }
                const fd = new FormData(); fd.append('file', f);
                $('annStatus').textContent = 'ä¸Šå‚³ä¸­...';
                try {
                    const r = await fetch('/announce_upload', { method: 'POST', body: fd });
                    const j = await r.json();
                    if (j.ok) {
                        currentImageUrl = j.url;
                        $('annImgUrl').textContent = j.url;
                        $('annStatus').textContent = 'åœ–ç‰‡å·²ä¸Šå‚³';
                        const p = $('annPreview');
                        if (p) { p.src = j.url; p.style.display = 'block'; }
                    } else {
                        $('annStatus').textContent = 'ä¸Šå‚³å¤±æ•—: ' + (j.error || '');
                    }
                } catch (e) {
                    $('annStatus').textContent = 'ä¸Šå‚³éŒ¯èª¤';
                }
            });

            $('annMediaUpload')?.addEventListener('click', async () => {
                const f = $('annMediaFile').files[0];
                if (!f) { $('annStatus').textContent = 'è«‹å…ˆé¸æ“‡éŸ³è¨Š/å½±ç‰‡'; return; }
                const fd = new FormData(); fd.append('file', f);
                $('annStatus').textContent = 'ä¸Šå‚³ä¸­...';
                try {
                    const r = await fetch('/announce_upload', { method: 'POST', body: fd });
                    const j = await r.json();
                    if (j.ok) {
                        currentMediaUrl = j.url;
                        $('annMediaUrl').textContent = j.url;
                        $('annStatus').textContent = 'åª’é«”å·²ä¸Šå‚³';
                    } else {
                        $('annStatus').textContent = 'ä¸Šå‚³å¤±æ•—: ' + (j.error || '');
                    }
                } catch (e) {
                    $('annStatus').textContent = 'ä¸Šå‚³éŒ¯èª¤';
                }
            });

            async function send(sound) {
                const message = ($('annMsg').value || '').trim();
                const body = { message, image: currentImageUrl, media: currentMediaUrl, sound: sound ? 1 : 0 };
                $('annStatus').textContent = 'é€å‡ºä¸­...';
                try {
                    const r = await fetch('/announce', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const j = await r.json();

                    if (j.ok) {
                        try {
                            $('annStatus').textContent = 'æ›´æ–°æˆåŠŸï¼Œæ­£åœ¨æ¨é€...';

                            // Get all connected clients
                            const clResp = await fetch('/controller/api/clients_v2');
                            const clData = await clResp.json();

                            if (clData.ok && clData.clients) {
                                const allTargets = Object.keys(clData.clients);
                                if (allTargets.length > 0) {
                                    const siteUrl = window.location.origin + "/static/ui/announce.html";

                                    await fetch('/controller/api/send_v2', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            targets: allTargets,
                                            cmd: "open_url",
                                            url: siteUrl
                                        })
                                    });
                                    $('annStatus').textContent = `å·²æ›´æ–°ä¸¦æ¨é€è‡³ ${allTargets.length} å°`;
                                } else {
                                    $('annStatus').textContent = 'å·²æ›´æ–° (ç„¡é€£ç·šé›»è…¦)';
                                }
                            } else {
                                $('annStatus').textContent = 'å·²æ›´æ–° (ç„¡æ³•å–å¾—åå–®)';
                            }
                        } catch (pushErr) {
                            console.error("æ¨é€å¤±æ•—:", pushErr);
                            $('annStatus').textContent = 'å·²æ›´æ–°ä½†æ¨é€å¤±æ•—';
                        }
                    } else {
                        $('annStatus').textContent = 'å¤±æ•—: ' + (j.error || '');
                    }
                } catch (e) {
                    $('annStatus').textContent = 'éŒ¯èª¤';
                    console.error(e);
                }
            }
            $('annSendSound')?.addEventListener('click', () => send(true));
            $('annSendSilent')?.addEventListener('click', () => send(false));
        })();
        // ==================== éœéŸ³å»£æ’­çµæŸ ====================

        window.addEventListener("load", () => {
            startClock();
            refreshClients();
            startAuto();
        });
    </script>


</body>

</html>