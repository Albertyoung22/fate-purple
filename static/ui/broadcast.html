<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¡Œå‹•å»£æ’­ç«™</title>
    <style>
        :root {
            --primary: #2196F3;
            --danger: #f44336;
            --success: #4CAF50;
            --bg: #f5f5f5;
            --text: #333;
        }

        body {
            margin: 0;
            padding: 16px;
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100dvh;
            box-sizing: border-box;
            display: block;
            overflow-y: auto;
        }

        header {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #555;
            flex: 0 0 auto;
        }

        #status {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
            height: 20px;
            flex: 0 0 auto;
        }

        /* Main Container */
        .container {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 40px;
        }

        /* Buttons */
        .btn {
            border: none;
            border-radius: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            user-select: none;
            /* Prevent text selection */
            -webkit-user-select: none;
            touch-action: manipulation;
            /* Improve touch response */
        }

        .btn:active {
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Hold to Talk - Big Button */
        #btn-hold {
            flex: 2;
            /* Takes more space */
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }

        #btn-hold.recording {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            animation: pulse 1.5s infinite;
        }

        /* Toggle Record - Smaller Button */
        #btn-toggle {
            flex: 1.5;
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        #btn-toggle.recording {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        #btn-toggle.preview {
            background: linear-gradient(135deg, #4CAF50, #388E3C);
        }

        /* Preview Controls */
        #preview-box {
            display: none;
            background: white;
            padding: 10px;
            border-radius: 12px;
            align-items: center;
            gap: 10px;
            flex: 0 0 auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        audio {
            flex: 1;
            height: 40px;
        }

        /* Animations */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(244, 67, 54, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0);
            }
        }

        .icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .hint {
            font-size: 0.8rem;
            opacity: 0.8;
            font-weight: normal;
        }

        /* Modal for Permissions */
        #mic-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            text-align: left;
        }

        .url-box {
            background: #eee;
            padding: 8px;
            border-radius: 6px;
            word-break: break-all;
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
        }
    </style>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196F3">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>

<body>

    <header style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
        <a href="index.html"
            style="text-decoration: none; font-size: 1rem; color: #555; display: inline-flex; align-items: center; gap: 4px;"
            title="å›é¦–é ">ğŸ  å›é¦–é </a>
        <span style="font-size: 1.2rem; font-weight: bold;">è¡Œå‹•å»£æ’­ç«™ ğŸ“¢ <span
                style="font-size:0.6em;opacity:0.7;">(Rev.3)</span></span>
    </header>
    <div id="status">æº–å‚™å°±ç·’</div>

    <!-- Container starts -->
    <div class="container">

        <!-- Options -->
        <div style="text-align:center; margin-bottom: 8px;">
            <label
                style="display:inline-flex;align-items:center;gap:8px;font-size:1.1rem;padding:8px;background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                <input type="checkbox" id="chk-chime" checked style="width:20px;height:20px;">
                <span>æ’­æ”¾æç¤ºéŸ³ (å‰å¾Œ)</span>
            </label>
            <label
                style="display:inline-flex;align-items:center;gap:8px;font-size:1.1rem;padding:8px;background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-left:8px;">
                <input type="checkbox" id="chk-noise" checked style="width:20px;height:20px;">
                <span>å•Ÿç”¨é™å™ª</span>
            </label>
        </div>

        <!-- Debug / Install Area -->
        <div style="text-align:center; margin-bottom: 15px;">
            <!-- Install Button -->
            <button id="btn-install" onclick="installApp()"
                style="display:none; margin:0 auto; background: #333; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); align-items: center; gap: 8px;">
                <span style="font-size: 1.2rem;">ğŸ“²</span>
                <span>å®‰è£æ­¤æ‡‰ç”¨ç¨‹å¼</span>
            </button>

            <!-- Diagnosise Button (Small text) -->
            <div style="margin-top:8px;">
                <span onclick="runPWADiagnosis()"
                    style="font-size: 0.8rem; text-decoration: underline; color: #999; cursor: pointer;">APP å®‰è£è¨ºæ–·</span>
            </div>
            <div id="debug-log"
                style="font-size: 0.75rem; color: #666; background: #eee; padding: 8px; margin-top: 8px; border-radius: 8px; text-align: left; display: none; white-space: pre-wrap;">
            </div>
        </div>

        <script>
            async function installApp() {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log("User response to install prompt:", outcome);
                deferredPrompt = null;
                document.getElementById('btn-install').style.display = 'none';
            }
        </script>

        <!-- Live Mode Toggle -->
        <div style="text-align:center; margin-bottom: 8px;">
            <div
                style="background: white; display: inline-flex; border-radius: 99px; padding: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <button id="mode-std" onclick="setMode('std')"
                    style="border:none; background:#2196F3; color:white; padding: 8px 16px; border-radius: 99px; font-weight:bold; transition:0.3s; font-size:1rem;">éŒ„éŸ³å‚³é€</button>
                <button id="mode-live" onclick="setMode('live')"
                    style="border:none; background:transparent; color:#666; padding: 8px 16px; border-radius: 99px; font-weight:bold; transition:0.3s; font-size:1rem;">ğŸ”´
                    å³æ™‚ç›´æ’­</button>
            </div>
            <div id="live-hint" style="font-size:12px; color:#f44336; margin-top:4px; display:none;">ä½å»¶é²ç›´æ’­æ¨¡å¼ (WIFIç’°å¢ƒä½³)
            </div>
        </div>

        <!-- Visualizer Canvas (Move here) -->
        <div id="visualizer-box" style="display:none; justify-content:center; margin-bottom:10px;">
            <canvas id="visualizer" width="300" height="60"
                style="border-radius:12px; background:#e0e0e0; border:1px solid #ccc;"></canvas>
        </div>

        <!-- Hold to Talk -->
        <button id="btn-hold" class="btn">
            <span class="icon">ğŸ¤</span>
            <span>æŒ‰ä½ â€§ å³èªª</span>
            <span class="hint">æ”¾é–‹ç«‹å³å»£æ’­</span>
        </button>

        <!-- Toggle Record -->
        <button id="btn-toggle" class="btn">
            <span class="icon">ğŸ”´</span>
            <span id="toggle-text">é»æ“Šé–‹å§‹éŒ„éŸ³</span>
            <span class="hint" id="toggle-hint">éŒ„è£½é•·æ®µèªéŸ³</span>
        </button>

        <!-- Live Chime Buttons (Hidden by default) -->
        <div id="live-chime-box" style="display:none; gap:12px; margin-top:8px;">
            <button onclick="playLiveChime('start')" class="btn"
                style="flex:1; background:white; color:#333; font-size:1rem; padding:12px;">
                ğŸ”” æç¤ºéŸ³
            </button>
            <button onclick="playLiveChime('end')" class="btn"
                style="flex:1; background:white; color:#333; font-size:1rem; padding:12px;">
                ğŸ”• çµæŸéŸ³
            </button>
        </div>

        <!-- Preview Box (Hidden by default) -->
        <div id="preview-box">
            <audio id="audio-preview" controls></audio>
            <button id="btn-cancel"
                style="padding: 8px 16px; border-radius: 8px; border: none; background: #9e9e9e; color: white;">âŒ</button>
        </div>

        <!-- Volume Control -->
        <div
            style="margin-top: 24px; background: white; padding: 16px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
            <label style="display:block; margin-bottom: 8px; font-weight: bold; color: #374151;">ğŸ”Š ç¾å ´éŸ³é‡</label>
            <div style="display: flex; align-items: center; gap: 12px;">
                <button onclick="adjustVol(-5)"
                    style="width:40px;height:40px;border-radius:50%;border:1px solid #ddd;background:#f3f4f6;font-size:1.2rem;">-</button>
                <input type="range" id="vol-slider" min="0" max="100" value="80" style="flex:1; height:8px;"
                    onchange="setVol(this.value)">
                <button onclick="adjustVol(+5)"
                    style="width:40px;height:40px;border-radius:50%;border:1px solid #ddd;background:#f3f4f6;font-size:1.2rem;">+</button>
            </div>
            <div id="vol-val" style="text-align:center; font-size: 0.9rem; color:#6b7280; margin-top:4px;">80%</div>
        </div>

        <!-- Force Stop -->
        <div style="margin-top: 16px;">
            <button onclick="forceStop()" class="btn"
                style="background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); width: 100%;">
                <span class="icon">ğŸ›‘</span>
                <span>å¼·åˆ¶åœæ­¢æ‰€æœ‰å»£æ’­</span>
            </button>
        </div>

        <!-- Relay Control -->
        <div style="margin-top: 16px; display: flex; gap: 12px;">
            <button onclick="sendCmd('RelayOn')" class="btn"
                style="flex: 1; background: linear-gradient(135deg, #4CAF50, #388E3C); font-size: 1.2rem; padding: 12px;">
                <span class="icon">ğŸ”Œ</span>
                <span>Relay ON</span>
            </button>
            <button onclick="sendCmd('RelayOff')" class="btn"
                style="flex: 1; background: linear-gradient(135deg, #9e9e9e, #616161); font-size: 1.2rem; padding: 12px;">
                <span class="icon">ğŸ”Œ</span>
                <span>Relay OFF</span>
            </button>
        </div>

        <!-- History -->
        <div style="margin-top: 24px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <label style="font-weight: bold; color: #374151;">ğŸ“ æœ€è¿‘å»£æ’­ (å‰5æ¬¡)</label>
                <button onclick="fetchHistory()"
                    style="background:none; border:none; color:#2563eb; font-size:0.9rem;">ğŸ”„
                    é‡æ–°æ•´ç†</button>
            </div>
            <div id="history-list" style="display:flex; flex-direction:column; gap:8px;">
                <div style="text-align:center; color:#9ca3af; padding:8px;">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- Permission Modal -->
    <div id="mic-modal">
        <div class="modal-content">
            <h3 style="color:#d32f2f;margin-top:0">âš ï¸ ç„¡æ³•ä½¿ç”¨éº¥å…‹é¢¨</h3>
            <p>å› ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼Œé HTTPS ç’°å¢ƒéœ€æ‰‹å‹•é–‹å•Ÿæ¬Šé™ã€‚</p>
            <ol style="padding-left:20px; font-size:14px; line-height:1.5;">
                <li>è¤‡è£½ä¸‹æ–¹ç¶²å€ï¼š<br>
                    <div class="url-box" id="flag-url">chrome://flags/#unsafely-treat-insecure-origin-as-secure</div>
                </li>
                <li>é–‹æ–°åˆ†é è²¼ä¸Šä¸¦å‰å¾€ã€‚</li>
                <li>å¡«å…¥æœ¬ç«™ç¶²å€ï¼š<br>
                    <div class="url-box" id="site-url" style="color:#2196F3;font-weight:bold;"></div>
                </li>
                <li>è¨­ç‚º <b>Enabled</b> ä¸¦ Relaunchã€‚</li>
            </ol>
            <div style="text-align:right">
                <button onclick="copyUrl()"
                    style="padding:8px 16px;background:#2196F3;color:white;border:none;border-radius:4px;">è¤‡è£½ Flag
                    ç¶²å€</button>
                <button onclick="copySiteUrl()"
                    style="padding:8px 16px;background:#4CAF50;color:white;border:none;border-radius:4px;margin-left:8px;">è¤‡è£½æœ¬ç«™ç¶²å€</button>
                <button onclick="document.getElementById('mic-modal').style.display='none'"
                    style="padding:8px 16px;background:#ddd;border:none;border-radius:4px;margin-left:8px;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let isVisualizing = false; // Separate flag for visualizer
        let broadcastMode = 'instant'; // 'instant' or 'preview'
        let recordedBlob = null;
        let currentMode = 'std'; // 'std' or 'live'
        let ws = null;

        // Visualizer State
        let audioCtx, analyser, dataArray, visualizerBox, visualizerCanvas, visualizerCtx, animationId;

        // --- References ---
        const btnHold = document.getElementById('btn-hold');
        const btnToggle = document.getElementById('btn-toggle');
        const toggleText = document.getElementById('toggle-text');
        const toggleHint = document.getElementById('toggle-hint');
        const statusEl = document.getElementById('status');
        const previewBox = document.getElementById('preview-box');
        const audioPreview = document.getElementById('audio-preview');
        const btnCancel = document.getElementById('btn-cancel');

        // Init Visualizer Refs
        visualizerBox = document.getElementById('visualizer-box');
        visualizerCanvas = document.getElementById('visualizer');
        visualizerCtx = visualizerCanvas.getContext('2d');

        // --- Helper ---
        function setStatus(msg) { statusEl.textContent = msg; }

        function ensureUnmute() {
            const slider = document.getElementById('vol-slider');
            if (!slider) return;
            // Always ensure server is unmuted
            fetch('/cmd', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'cmd=Unmute'
            }).catch(() => { });

            let v = parseInt(slider.value || "0", 10);
            if (v === 0) {
                v = 50;
                slider.value = v;
                setVol(v);
                setStatus("ğŸ”Š å·²è‡ªå‹•è§£é™¤éœéŸ³");
            }
        }

        function drawVisualizer() {
            if (!isVisualizing) return;
            animationId = requestAnimationFrame(drawVisualizer);

            analyser.getByteFrequencyData(dataArray);

            visualizerCtx.fillStyle = '#f0f0f0';
            visualizerCtx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);

            const barWidth = (visualizerCanvas.width / dataArray.length) * 2.5;
            let barHeight;
            let x = 0;

            for (let i = 0; i < dataArray.length; i++) {
                barHeight = dataArray[i] / 2;

                // Color based on height (Green -> Red)
                if (barHeight > 50) visualizerCtx.fillStyle = '#f44336';
                else if (barHeight > 30) visualizerCtx.fillStyle = '#ff9800';
                else visualizerCtx.fillStyle = '#4CAF50';

                visualizerCtx.fillRect(x, visualizerCanvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        }

        async function checkMicPermission() {
            // 1. Check for Secure Context (HTTPS or localhost)
            if (!window.isSecureContext && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                // Try to proceed anyway, but show modal if mediaDevices is missing
                if (!navigator.mediaDevices) {
                    showPermissionModal();
                    return false;
                }
            }

            // 2. Check Device Support
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showPermissionModal();
                return false;
            }
            return true;
        }

        function showPermissionModal() {
            // Update URL specific instructions
            const currentUrl = window.location.href;
            document.getElementById('site-url').textContent = currentUrl;
            document.getElementById('mic-modal').style.display = 'flex';
        }

        window.copyUrl = () => {
            const txt = document.getElementById('flag-url').textContent;
            // Fallback copy
            const ta = document.createElement("textarea");
            ta.value = txt;
            ta.style.position = "fixed"; ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.focus(); ta.select();
            try {
                document.execCommand('copy');
                alert("å·²è¤‡è£½ï¼");
            } catch (e) {
                prompt("è«‹æ‰‹å‹•è¤‡è£½:", txt);
            }
            document.body.removeChild(ta);
        };

        window.copySiteUrl = () => {
            const txt = document.getElementById('site-url').textContent;
            // Fallback copy
            const ta = document.createElement("textarea");
            ta.value = txt;
            ta.style.position = "fixed"; ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.focus(); ta.select();
            try {
                document.execCommand('copy');
                alert("å·²è¤‡è£½æœ¬ç«™ç¶²å€ï¼");
            } catch (e) {
                prompt("è«‹æ‰‹å‹•è¤‡è£½:", txt);
            }
            document.body.removeChild(ta);
        };

        // --- Core Recording Logic ---
        function setMode(m) {
            currentMode = m;
            const btnStd = document.getElementById('mode-std');
            const btnLive = document.getElementById('mode-live');
            const hint = document.getElementById('live-hint');

            if (m === 'live') {
                btnLive.style.background = '#f44336';
                btnLive.style.color = 'white';
                btnStd.style.background = 'transparent';
                btnStd.style.color = '#666';
                hint.style.display = 'block';

                document.querySelector('#btn-hold span:nth-child(2)').textContent = "æŒ‰ä½ â€§ ç›´æ’­";
                document.querySelector('#btn-hold .hint').textContent = "æ”¾é–‹ç«‹å³åœæ­¢";

                document.getElementById('toggle-text').textContent = "é»æ“Šé–‹å§‹ç›´æ’­";
                document.getElementById('toggle-hint').textContent = "ç›´æ’­ç›´åˆ°åœæ­¢";
            } else { // std
                btnStd.style.background = '#2196F3';
                btnStd.style.color = 'white';
                btnLive.style.background = 'transparent';
                btnLive.style.color = '#666';
                hint.style.display = 'none';

                document.querySelector('#btn-hold span:nth-child(2)').textContent = "æŒ‰ä½ â€§ å³èªª";
                document.querySelector('#btn-hold .hint').textContent = "æ”¾é–‹ç«‹å³å»£æ’­";

                document.getElementById('toggle-text').textContent = "é»æ“Šé–‹å§‹éŒ„éŸ³";
                document.getElementById('toggle-hint').textContent = "éŒ„è£½é•·æ®µèªéŸ³";
            }

            // Toggle Chime Box
            const chimeBox = document.getElementById('live-chime-box');
            if (chimeBox) chimeBox.style.display = (m === 'live') ? 'flex' : 'none';
        }

        async function startRecording(mode) {
            ensureUnmute();
            // 1. Init AudioContext and Visualizer UI immediately (User Gesture)
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                // Show visualizer placeholder immediately
                if (visualizerBox) visualizerBox.style.display = 'flex';
            } catch (e) { console.error("AudioCtx Error:", e); }

            if (!await checkMicPermission()) return;

            try {
                const useNoise = document.getElementById("chk-noise").checked;

                // Use simpler constraints to ensure compatibility
                let constraints = { audio: true };

                if (!useNoise) {
                    constraints = {
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        }
                    };
                }

                const stream = await navigator.mediaDevices.getUserMedia(constraints);

                // Visualizer Connection
                if (audioCtx && stream.getAudioTracks().length > 0) {
                    const source = audioCtx.createMediaStreamSource(stream);
                    if (!analyser) {
                        analyser = audioCtx.createAnalyser();
                        analyser.fftSize = 64;
                        dataArray = new Uint8Array(analyser.frequencyBinCount);
                    }
                    source.connect(analyser);

                    isVisualizing = true;
                    drawVisualizer();
                }

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                // Visualizer already started above

                // UI Updates
                if (currentMode === 'live') {
                    // LIVE MODE LOGIC
                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0 && ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(event.data);
                        }
                    };

                    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
                    ws = new WebSocket(`${proto}//${location.host}/ws/live?role=broadcaster`);

                    ws.onopen = () => {
                        mediaRecorder.start(500); // 500ms chunks for better stability
                        isRecording = true;
                        setStatus("ğŸ”´ ç›´æ’­ä¸­...");

                        // UI
                        if (mode === 'instant') { // Hold
                            btnHold.classList.add('recording');
                            btnToggle.disabled = true;
                        } else { // Toggle
                            btnToggle.classList.add('recording');
                            toggleText.textContent = "åœæ­¢ç›´æ’­";
                            toggleHint.textContent = "é»æ“ŠçµæŸ";
                            btnHold.disabled = true;
                        }
                    };
                    ws.onerror = (e) => {
                        console.error(e);
                        setStatus("âŒ é€£ç·šéŒ¯èª¤");
                        if (isRecording) stopRecording();
                    };
                    return;
                }

                // STANDARD RECORDING LOGIC
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    if (currentMode === 'live') return; // Handled separately if mixed? No.
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    recordedBlob = blob;
                    handleRecordingComplete(blob);

                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                broadcastMode = mode;
                setStatus("ğŸ”´ éŒ„éŸ³ä¸­...");

                // UI Updates
                if (mode === 'instant') {
                    btnHold.classList.add('recording');
                    btnToggle.disabled = true;
                    btnHold.querySelector('.hint').textContent = "æ”¾é–‹ -> å‚³é€";
                } else {
                    btnToggle.classList.add('recording');
                    toggleText.textContent = "åœæ­¢ä¸¦é è¦½";
                    toggleHint.textContent = "é»æ“ŠçµæŸéŒ„éŸ³";
                    btnHold.disabled = true;
                }

            } catch (err) {
                console.error(err);
                setStatus("âŒ éº¥å…‹é¢¨å•Ÿå‹•å¤±æ•—");
                alert("éº¥å…‹é¢¨å•Ÿå‹•å¤±æ•—: " + err.message);
            }
        }

        function stopRecording() {
            isVisualizing = false;

            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;

                // Stop Visualizer
                if (animationId) cancelAnimationFrame(animationId);
                visualizerBox.style.display = 'none';

                // If Live Mode, close WS and Reset UI immediately
                if (currentMode === 'live') {
                    if (ws) ws.close();
                    setStatus("ç›´æ’­çµæŸ");
                    setTimeout(() => setStatus("æº–å‚™å°±ç·’"), 2000);

                    btnHold.classList.remove('recording');
                    btnToggle.classList.remove('recording');
                    btnHold.disabled = false;
                    btnToggle.disabled = false;

                    // Reset Toggle Text
                    toggleText.textContent = "é»æ“Šé–‹å§‹ç›´æ’­";
                    toggleHint.textContent = "ç›´æ’­ç›´åˆ°åœæ­¢";

                    // Release Stream
                    if (mediaRecorder.stream) {
                        mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    }
                }
            } else {
                // Determine if we need to cleanup visualizer if isRecording was false (e.g. error case or early stop)
                if (animationId) cancelAnimationFrame(animationId);
                visualizerBox.style.display = 'none';

                // Also release any stream if it exists but wasn't recording
                if (mediaRecorder && mediaRecorder.stream) {
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
            }
        }

        async function handleRecordingComplete(blob) {
            // Reset UI first
            btnHold.classList.remove('recording');
            btnToggle.classList.remove('recording');
            btnHold.disabled = false;
            btnToggle.disabled = false;
            btnHold.querySelector('.hint').textContent = "æ”¾é–‹ç«‹å³å»£æ’­";
            toggleText.textContent = "é»æ“Šé–‹å§‹éŒ„éŸ³";
            toggleHint.textContent = "éŒ„è£½é•·æ®µèªéŸ³";

            if (blob.size < 1024) {
                setStatus("âš ï¸ éŒ„éŸ³å¤ªçŸ­ (<1KB)ï¼Œå·²å–æ¶ˆ");
                resetPreview();
                return;
            }

            if (broadcastMode === 'instant') {
                // Check duration (avoid tiny accidental clicks)
                // Size checked above
                setStatus("â³ ä¸Šå‚³å»£æ’­ä¸­...");
                await uploadAudio(blob);
            } else {
                // Preview Mode
                setStatus("â–¶ï¸ æº–å‚™é è¦½");
                const url = URL.createObjectURL(blob);
                audioPreview.src = url;
                previewBox.style.display = 'flex';

                // Change Toggle Button to Send
                btnToggle.classList.add('preview');
                // Change text to 'Send'
                toggleText.textContent = "ğŸ“¤ ç¢ºèªå‚³é€";
                toggleHint.textContent = "ç”±æ‰‹æ©Ÿå»£æ’­";

                // Hide hold button temporarily
                btnHold.style.display = 'none';

                // Override click handler for Send
                // We handle this state in the click listener below
            }
        }

        async function uploadAudio(blob) {
            const formData = new FormData();
            formData.append("file", blob, "mobile_voice.webm");

            // Add Chime option
            const useChime = document.getElementById("chk-chime").checked;
            formData.append("chime", useChime ? "true" : "false");

            try {
                const res = await fetch("/api/speak_audio_blob", {
                    method: "POST",
                    body: formData
                });
                if (res.ok) {
                    setStatus("âœ… å»£æ’­æˆåŠŸï¼");
                    fetchHistory();
                    setTimeout(() => setStatus("æº–å‚™å°±ç·’"), 3000);
                } else {
                    const txt = await res.text();
                    throw new Error(txt);
                }
            } catch (e) {
                setStatus("âŒ å‚³é€å¤±æ•—");
                alert("å‚³é€å¤±æ•—: " + e.message);
            }
        }

        function resetPreview() {
            previewBox.style.display = 'none';
            audioPreview.pause();
            audioPreview.src = "";
            recordedBlob = null;

            btnToggle.classList.remove('preview');
            toggleText.textContent = "é»æ“Šé–‹å§‹éŒ„éŸ³";
            toggleHint.textContent = "éŒ„è£½é•·æ®µèªéŸ³";
            btnHold.style.display = 'flex';
            setStatus("æº–å‚™å°±ç·’");
        }

        // --- Volume & Logic ---
        function adjustVol(delta) {
            const slider = document.getElementById('vol-slider');
            let v = parseInt(slider.value) + delta;
            if (v < 0) v = 0; if (v > 100) v = 100;
            slider.value = v;
            setVol(v);
        }

        function setVol(v) {
            document.getElementById('vol-val').innerText = v + "%";
            fetch('/setvol', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'vol=' + v
            });
        }

        function forceStop() {
            // Immediate action
            fetch('/cmd', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'cmd=CancelALL'
            }).then(() => {
                setStatus("ğŸ›‘ å·²åŸ·è¡Œå¼·åˆ¶åœæ­¢");
                resetPreview();
                setTimeout(() => setStatus("æº–å‚™å°±ç·’"), 3000);
            });
        }

        function sendCmd(cmd) {
            fetch('/cmd', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'cmd=' + cmd
            }).then(() => {
                setStatus("âœ… æŒ‡ä»¤å·²ç™¼é€: " + cmd);
                setTimeout(() => setStatus("æº–å‚™å°±ç·’"), 2000);
            }).catch(e => {
                setStatus("âŒ ç™¼é€å¤±æ•—");
                alert("ç™¼é€å¤±æ•—: " + e);
            });
        }

        async function fetchHistory() {
            const list = document.getElementById('history-list');
            try {
                const r = await fetch('/files?source=rec');
                const j = await r.json();
                if (!j.ok) throw new Error("API Fail: " + (j.error || "unknown"));

                // Filter: show .mp3s, but exclude the generated '_chime' files
                const recs = j.files
                    .filter(f => f.name.toLowerCase().endsWith('.mp3'))
                    .filter(f => !f.name.toLowerCase().endsWith('_chime.mp3'))
                    .sort((a, b) => b.mtime - a.mtime)
                    .slice(0, 5);

                if (recs.length === 0) {
                    list.innerHTML = `<div style="text-align:center; color:#9ca3af; padding:8px;">ç„¡éŒ„éŸ³è¨˜éŒ„ (å…± ${j.files.length} æª”æ¡ˆ)</div>`;
                    return;
                }

                list.innerHTML = recs.map(f => {
                    const d = new Date(f.mtime * 1000);
                    const timeStr = (d.getMonth() + 1) + "/" + d.getDate() + " " +
                        String(d.getHours()).padStart(2, '0') + ":" + String(d.getMinutes()).padStart(2, '0') + ":" + String(d.getSeconds()).padStart(2, '0');
                    const label = f.orig && f.orig.startsWith("éŒ„éŸ³-") ? f.orig : "éŒ„éŸ³";

                    return `
                    <div style="display:flex; align-items:center; background:white; padding:10px; border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                        <div style="flex:1;">
                            <div style="font-weight:bold; color:#333;">${label}</div>
                            <div style="font-size:0.8rem; color:#666;">${timeStr}</div>
                        </div>
                        <button onclick="playHistory('${f.name}')" style="background:#dbeafe; color:#1e40af; border:none; padding:8px 16px; border-radius:8px; display:flex; align-items:center; gap:4px; font-size:0.9rem;">
                            <span>â–¶ï¸</span> é‡æ’­
                        </button>
                    </div>
                    `;
                }).join('');

            } catch (e) {
                console.error(e);
                list.innerHTML = `<div style="text-align:center; color:#ef4444; padding:8px;">è¼‰å…¥å¤±æ•—: ${e.message}</div>`;
            }
        }

        let isPlayingHistory = false;

        function playHistory(path) {
            if (isPlayingHistory) return;
            ensureUnmute();
            if (!confirm("ç¢ºå®šè¦å†æ¬¡å»£æ’­æ­¤å…§å®¹å—ï¼Ÿ")) return;

            isPlayingHistory = true;

            const chk = document.getElementById('chk-chime');
            const useChime = chk && chk.checked;
            const cmdName = useChime ? "PlayWithChime:" : "PlayMP3:";

            fetch('/cmd', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'cmd=' + cmdName + path
            }).then(() => {
                setStatus("âœ… é‡æ’­æŒ‡ä»¤å·²ç™¼é€" + (useChime ? " (å«æç¤ºéŸ³)" : ""));
                setTimeout(() => setStatus("æº–å‚™å°±ç·’"), 2000);
            }).finally(() => {
                setTimeout(() => { isPlayingHistory = false; }, 1000);
            });
        }

        // Init state
        fetch('/state').then(r => r.json()).then(d => {
            if (d.volume !== undefined) {
                document.getElementById('vol-slider').value = d.volume;
                document.getElementById('vol-val').innerText = d.volume + "%";
            }
        }).catch(() => { });

        fetchHistory();

        // --- Event Listeners ---

        // 1. Hold to Talk
        const handleStart = (e) => {
            if (e.cancelable) e.preventDefault(); // Prevent scrolling on touch
            if (isRecording || previewBox.style.display === 'flex') return;
            startRecording('instant');
        };
        const handleEnd = (e) => {
            if (e.cancelable) e.preventDefault();
            if (isRecording && broadcastMode === 'instant') {
                stopRecording();
            }
        };

        btnHold.addEventListener('mousedown', handleStart);
        btnHold.addEventListener('touchstart', handleStart);

        btnHold.addEventListener('mouseup', handleEnd);
        btnHold.addEventListener('touchend', handleEnd);
        btnHold.addEventListener('mouseleave', () => {
            if (isRecording && broadcastMode === 'instant') stopRecording();
        });

        // 2. Toggle Record / Send
        btnToggle.addEventListener('click', () => {
            // State: Sending (Preview)
            if (btnToggle.classList.contains('preview')) {
                if (recordedBlob) {
                    setStatus("â³ ä¸Šå‚³ä¸­...");
                    btnToggle.disabled = true;
                    uploadAudio(recordedBlob).finally(() => {
                        btnToggle.disabled = false;
                        resetPreview();
                    });
                }
                return;
            }

            // State: Recording -> Stop
            if (isRecording) {
                stopRecording();
                return;
            }

            // State: Idle -> Start Recording (Preview Mode)
            startRecording('preview');
        });

        // 3. Cancel
        btnCancel.addEventListener('click', resetPreview);

        // Prevent context menu on buttons (long press)
        window.oncontextmenu = function (event) {
            event.preventDefault();
            event.stopPropagation();
            return false;
        };

        function playLiveChime(type) {
            ensureUnmute();
            // type: 'start' or 'end'
            fetch('/cmd', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'cmd=PlayChime:' + type
            }).then(() => {
                setStatus(type === 'start' ? "ğŸ”” æ’­æ”¾æç¤ºéŸ³" : "ğŸ”• æ’­æ”¾çµæŸéŸ³");
                setTimeout(() => {
                    if (isRecording) setStatus("ğŸ”´ ç›´æ’­ä¸­...");
                    else setStatus("æº–å‚™å°±ç·’");
                }, 1500);
            });
        }


        // --- PWA Logic ---
        let deferredPrompt;
        const btnInstall = document.getElementById('btn-install'); // We need to add this button to HTML

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later.
            deferredPrompt = e;

            // Show the install button
            if (btnInstall) {
                btnInstall.style.display = 'flex';
                setStatus("ğŸ“² å¯å®‰è£ App");
            }
            console.log("PWA: beforeinstallprompt fired");
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => {
                        console.log('SW reg success:', reg.scope);
                        // Check if controlling
                        if (!navigator.serviceWorker.controller) {
                            console.log("PWA: SW registered but not controlling yet. Reload might be needed.");
                        }
                    })
                    .catch(err => {
                        console.error('SW reg fail:', err);
                        setStatus("âš ï¸ SW è¨»å†Šå¤±æ•—");
                    });
            });
        }

        // Check Secure Context
        if (!window.isSecureContext && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            console.warn("PWA: Not secure context. Install might fail.");
            // We can allow the user to see a warning if they want
        }

        // --- PWA Diagnosis ---
        async function runPWADiagnosis() {
            const logEl = document.getElementById('debug-log');
            if (!logEl) return;
            logEl.style.display = 'block';
            logEl.textContent = "æ­£åœ¨æª¢æŸ¥ç’°å¢ƒ...\n";

            function log(msg) {
                logEl.textContent += msg + "\n";
                // console.log("[Diag] " + msg);
            }

            // 1. Basic Protocol & Secure Context
            log(`URL: ${window.location.protocol}//${window.location.host}`);
            log(`Secure Context: ${window.isSecureContext ? "âœ… Yes" : "âŒ No (å¿…å‚™æ¢ä»¶)"}`);

            if (!window.isSecureContext && window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                log("âš ï¸ è­¦å‘Š: é HTTPS ä¸”é localhostï¼ŒChrome 99% æœƒé˜»æ“‹å®‰è£ã€‚è«‹è¨­å®š chrome://flags");
            }

            // 2. Service Worker
            if ('serviceWorker' in navigator) {
                try {
                    const reg = await navigator.serviceWorker.getRegistration();
                    if (reg) {
                        log(`âœ… SW å·²è¨»å†Š (Scope: ${reg.scope})`);
                    } else {
                        log("âŒ SW æœªè¨»å†Š (å˜—è©¦é‡æ–°æ•´ç†)");
                    }
                } catch (e) {
                    log("âŒ SW æª¢æŸ¥éŒ¯èª¤: " + e);
                }
            } else {
                log("âŒ ç€è¦½å™¨ä¸æ”¯æ´ Service Worker");
            }

            // 3. Manifest
            try {
                const res = await fetch('manifest.json');
                if (res.ok) {
                    log("âœ… Manifest è®€å–æˆåŠŸ");
                    const json = await res.json();
                } else {
                    log(`âŒ Manifest è®€å–å¤±æ•— (Status: ${res.status})`);
                }
            } catch (e) {
                log("âŒ Manifest è«‹æ±‚éŒ¯èª¤: " + e);
            }

            // 4. Icons Check
            const iconUrl = 'icon_192.png';
            const img = new Image();
            img.onload = () => log("âœ… Icon 192 è®€å–æˆåŠŸ");
            img.onerror = () => log("âŒ Icon 192 è®€å–å¤±æ•—");
            img.src = iconUrl;

            // 5. Install Prompt Event
            if (deferredPrompt) {
                log("âœ… å®‰è£äº‹ä»¶å·²æ•æ‰ (å¯å®‰è£)");
                const btn = document.getElementById('btn-install');
                if (btn) btn.style.display = 'flex';
            } else {
                log("âš ï¸ æœªæ•æ‰åˆ°å®‰è£äº‹ä»¶ã€‚");
                log("å¯èƒ½åŸå› ï¼š\n1. å·²ç¶“å®‰è£é (è«‹æª¢æŸ¥ APP åˆ—è¡¨)\n2. æ¢ä»¶ä¸ç¬¦ (çœ‹ä¸Šæ–¹æª¢æŸ¥)\n3. æ›¾ç¶“æ‹’çµ•é (è«‹æ¸…é™¤å¿«å–)");
            }
        }
    </script>

</body>

</html>