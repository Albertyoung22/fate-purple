<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ site_title }}</title>
    <link rel="stylesheet" href="/static/ui/ui.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

        * {
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
            --danger-gradient: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.3);
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
            --shadow-xl: 0 12px 48px rgba(0, 0, 0, 0.20);
        }

        body {
            margin: 0;
            padding: 16px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', sans-serif;
            font-size: 14px;
            line-height: 1.5;
            background: var(--primary-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .wrap {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto 24px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 18px;
            padding: 24px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-xl);
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin: 8px 0;
        }

        .row>* {
            min-width: 0;
        }

        .row label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
            letter-spacing: 0.3px;
        }

        .mono {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .muted {
            color: var(--text-muted);
        }

        .grid.g3 {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
            position: relative;
            z-index: 1;
        }

        @media (max-width:1100px) {
            .grid.g3 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width:720px) {
            .grid.g3 {
                grid-template-columns: 1fr;
            }

            body {
                padding: 12px;
            }

            .wrap {
                padding: 16px;
            }
        }

        .card {
            position: relative;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: cardFadeIn 0.6s ease-out backwards;
        }

        @keyframes cardFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .card:nth-child(1) {
            animation-delay: 0.05s;
        }

        .card:nth-child(2) {
            animation-delay: 0.1s;
        }

        .card:nth-child(3) {
            animation-delay: 0.15s;
        }

        .card:nth-child(4) {
            animation-delay: 0.2s;
        }

        .card:nth-child(5) {
            animation-delay: 0.25s;
        }

        .card:nth-child(6) {
            animation-delay: 0.3s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card h3 {
            margin: 0;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 800;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card h3 span:first-child {
            font-size: 18px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card .row {
            padding: 0 20px;
        }

        .card .row:last-child {
            padding-bottom: 20px;
        }

        .prev-wrap {
            position: relative;
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            margin: 8px 0;
        }

        .video-prev {
            width: 100%;
            max-height: 35vh;
            background: #000;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            transition: transform 0.3s ease;
        }

        .video-prev:hover {
            transform: scale(1.02);
        }

        .input {
            padding: 6px 10px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            font-family: inherit;
            font-size: 12px;
            transition: all 0.3s ease;
            outline: none;
        }

        .input:focus {
            border-color: #667eea;
            background: #ffffff;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        select.input {
            padding: 6px 10px;
            width: 100%;
            cursor: pointer;
        }

        .btn {
            border: none;
            border-radius: 10px;
            padding: 6px 12px;
            font-weight: 700;
            background: var(--primary-gradient);
            color: #ffffff;
            box-shadow: var(--shadow-sm);
            line-height: 1.4;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 12px;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            font-family: inherit;
            letter-spacing: 0.3px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.accent {
            background: var(--info-gradient);
        }

        .btn.warn {
            background: var(--warning-gradient);
            color: #1a202c;
        }

        .btn.small {
            padding: 3px 8px;
            font-size: 10px;
        }

        .badge {
            margin-left: auto;
            padding: 4px 10px;
            border-radius: 16px;
            font-weight: 700;
            font-size: 11px;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .badge.alive {
            background: var(--success-gradient);
            color: #ffffff;
        }

        .badge.dead {
            background: var(--danger-gradient);
            color: #ffffff;
        }

        .smallmuted {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .tiny {
            font-size: 11px;
        }

        .mini-online {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin: 8px 0;
        }

        .mini-online th,
        .mini-online td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .mini-online th {
            text-align: left;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            position: sticky;
            top: 0;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.3px;
        }

        .mini-online tbody tr {
            transition: background 0.2s ease;
        }

        .mini-online tbody tr:hover {
            background: rgba(102, 126, 234, 0.03);
        }

        .msgBarCard {
            display: none;
            position: absolute;
            left: 12px;
            right: 12px;
            top: 12px;
            background: var(--primary-gradient);
            color: #ffffff !important;
            border-radius: 16px;
            padding: 12px 16px;
            box-shadow: var(--shadow-lg);
            font-weight: 800;
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .msgBarCard .inner {
            overflow: hidden;
            white-space: nowrap;
            width: 100%;
        }

        .msgBarCard .marquee {
            display: inline-block;
            will-change: transform;
            padding-left: 5vw;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            color: #ffffff !important;
            font-size: 16px;
            letter-spacing: 0.5px;
        }

        @keyframes marqueeVar {
            from {
                transform: translateX(var(--start, 100%));
            }

            to {
                transform: translateX(var(--end, -100%));
            }
        }

        .sched-list {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 10px;
        }

        .sched-list th,
        .sched-list td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .sched-list th {
            text-align: left;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            font-weight: 700;
            color: var(--text-primary);
        }

        .sched-list tbody tr {
            transition: background 0.2s ease;
        }

        .sched-list tbody tr:hover {
            background: rgba(102, 126, 234, 0.03);
        }

        .page-head {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
            text-align: left;
        }

        .page-head h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(135deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 1px;
            text-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            display: inline-flex;
            align-items: baseline;
            gap: 8px;
        }

        .page-head .info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .note {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .note-inline {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.85);
        }

        .home-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            background: rgba(255, 255, 255, 0.12);
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .home-link:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .home-link .icon {
            width: 14px;
            height: 14px;
            display: inline-flex;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        .loading {
            animation: shimmer 2s infinite;
            background: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
            background-size: 1000px 100%;
        }

        #qrFloatBtn {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            background: var(--info-gradient);
            color: #ffffff;
            border: none;
            padding: 6px 12px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            font-size: 12px;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        #logoutFloat {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }

        #qrFloatBtn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--shadow-xl);
        }

        .logout-btn {
            background: #f87171;
            border: none;
            border-radius: 999px;
            color: #ffffff;
            padding: 6px 14px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .logout-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .logout-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
    <script defer src="/static/ui/auth.js"></script>
</head>

<body>
    <div class="wrap">
        <div class="page-head">
            <div class="info">
                <h2>æ•™å¸«ç«¯æ§åˆ¶å° <span class="note-inline">å¤šåª’é«”å»£æ’­ç³»çµ± - æ™ºèƒ½åŒæ­¥æ§åˆ¶ä¸­å¿ƒ</span></h2>
            </div>
            <div style="display:flex; gap:8px;">
                <a class="home-link" href="/static/ui/index.html" title="é¦–é ">
                    <span class="icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 12l9-8 9 8" />
                            <path d="M9 21V12h6v9" />
                        </svg>
                    </span>
                    é¦–é 
                </a>
                <button class="logout-btn" onclick="logoutUser()" id="logoutBtnPage"
                    style="padding: 6px 14px; font-size: 12px;">ç™»å‡º</button>
            </div>
        </div>

        <!-- Student Control Panel (Integrated) -->
        <div class="card" style="margin-bottom: 24px;">
            <h3><span>ğŸ–¥ï¸ å­¸ç”Ÿç«¯æ§åˆ¶èˆ‡ç‹€æ…‹</span></h3>
            <div class="row"
                style="justify-content:space-between; padding:0 16px 12px; border-bottom:1px solid rgba(0,0,0,0.05);">
                <div class="muted">
                    <button class="btn small" onclick="refreshClients()" style="margin-right:8px;">åˆ·æ–°åå–®</button>
                    ä¸Šç·šï¼š<span id="summaryOnline" style="font-weight:bold; color:#0a8754;">0</span> / <span
                        id="summaryTotal">0</span>
                </div>
                <div class="row tight" style="gap:8px; flex-wrap:wrap;">
                    <!-- Group Quick Actions -->
                    <div style="display:flex; gap:4px;">
                        <button class="btn small" onclick="quickOpenGroup(1)">G1</button>
                        <button class="btn small" onclick="quickOpenGroup(2)">G2</button>
                        <button class="btn small" onclick="quickOpenGroup(3)">G3</button>
                        <button class="btn small" onclick="quickOpenGroup(4)">G4</button>
                        <button class="btn small" onclick="quickOpenGroup(5)">G5</button>
                        <button class="btn small" onclick="quickOpenGroup(6)">G6</button>
                    </div>
                    <!-- System Actions -->
                    <button class="btn small warn" onclick="sendSysCmd('shutdown')">å…¨é«”é—œæ©Ÿ</button>
                    <button class="btn small warn" onclick="sendSysCmd('reboot')">å…¨é«”é‡é–‹</button>
                    <button class="btn small" onclick="quickCmd('lock')">å‹¾é¸é–å®š</button>
                    <button class="btn small" onclick="quickCmd('wol')">å‹¾é¸é–‹æ©Ÿ (WOL)</button>
                    <button class="btn small accent" onclick="quickOpenUrl(true)">å‹¾é¸éœéŸ³å»£æ’­</button>
                </div>
            </div>

            <div style="max-height:400px; overflow-y:auto;">
                <table class="mini-online" style="margin:0;">
                    <thead>
                        <tr>
                            <th style="width:40px; text-align:center;"><input type="checkbox" id="chkAll"
                                    onchange="toggleAll(this)"></th>
                            <th>ID</th>
                            <th>åç¨±</th>
                            <th>IP</th>
                            <th>ç‹€æ…‹</th>
                            <th style="text-align:right;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="clientBody">
                        <tr>
                            <td colspan="6" class="muted" style="text-align:center; padding:20px;">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="status smallmuted" id="quickStatus" style="padding:8px 16px; text-align:right;"></div>
        </div>

        <!-- å…¨åŸŸå·¥å…· -->
        <div class="row" style="align-items:flex-end; gap:12px;">
            <label>å»£æ’­å…§å®¹</label>
            <input id="msgText" class="input" placeholder="è«‹è¼¸å…¥è¦é¡¯ç¤ºçš„è¨Šæ¯â€¦"
                style="flex:1; min-width:220px; padding:6px 10px;">
            <label style="margin-left:auto;">é¡¯ç¤ºç§’æ•¸</label>
            <input id="msgDuration" class="input" type="number" min="0" step="1" value="10" style="width:110px">
            <span class="smallmuted" style="white-space:nowrap; color: rgba(255, 255, 255, 0.9);">0 = å¸¸é§ï¼Œç›´åˆ°æ¸…é™¤</span>
        </div>
        <div class="row">
            <label>ç›®æ¨™çµ„åˆ¥</label>
            <div id="msgGroups" class="row" style="gap:8px"></div>
        </div>

        <!-- Groups Grid (Dynamic) -->
        <div id="groupsGrid" class="grid g3" style="margin-bottom: 24px;"></div>
    </div>


    <script>
        /* ====== ?====== */
        const GROUP_COUNT = 6;

        function redirectToLogin() {
            const next = encodeURIComponent(window.location.pathname + window.location.search);
            window.location.href = '/login?next=' + next;
        }

        async function ensureLoggedIn() {
            const resp = await fetch('/auth/status', { credentials: 'same-origin', cache: 'no-store' });
            if (!resp.ok) {
                redirectToLogin();
                throw new Error('AUTH_CHECK_FAILED');
            }
            const data = await resp.json();
            if (!data.logged_in) {
                redirectToLogin();
                throw new Error('NOT_LOGGED_IN');
            }
            window.currentUser = data.user || null;
            return data.user || null;
        }

        async function authFetch(url, options) {
            const opts = Object.assign({ credentials: 'same-origin' }, options || {});
            const resp = await fetch(url, opts);
            if (resp.status === 401 || resp.status === 403) {
                redirectToLogin();
                throw new Error('UNAUTHORIZED');
            }
            return resp;
        }

        async function logoutUser() {
            try {
                const btn = document.getElementById('logoutBtnPage');
                if (btn) {
                    btn.disabled = true;
                }
                await authFetch('/auth/logout', { method: 'POST' });
            } catch (err) {
                console.warn('logout failed', err);
            } finally {
                window.location.href = '/login';
            }
        }

        /* ====== API ç™¼é€ ====== */
        function sendCmd(groups, action, payload) {
            var body = { groups: groups, action: action, payload: payload || {} };
            return authFetch('/api/cmd', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
            }).then(function (r) { return r.json(); }).catch(function () { return { ok: false, error: 'network' }; });
        }
        function sendTo(group, action, payload) { return sendCmd([group], action, payload); }

        /* ====== è¨­å‚™ç®¡ç† ====== */
        function toggleDevicesPanel() {
            var p = document.getElementById('devicesPanel');
            p.style.display = (p.style.display === 'none') ? 'block' : 'none';
            if (p.style.display === 'block') loadDevices();
        }
        function loadDevices() {
            authFetch('/api/clients')
                .then(function (r) { return r.json(); })
                .then(function (j) {
                    var tbody = document.getElementById('devicesTableBody');
                    if (!j.ok || !j.clients.length) { tbody.innerHTML = '<tr><td colspan="6" class="muted">ç„¡é€£ç·šè¨­å‚™</td></tr>'; return; }
                    tbody.innerHTML = j.clients.map(function (c) {
                        return '<tr>' +
                            '<td class="mono">' + c.ip + '</td>' +
                            '<td class="mono">' + c.mac + '</td>' +
                            '<td>' + c.hostname + '</td>' +
                            '<td>' + (c.group || '-') + '</td>' +
                            '<td>' + (c.platform || '-') + '</td>' +
                            '<td>' +
                            '<button class="btn small" onclick="wakeDevice(\'' + c.mac + '\')">Wake</button> ' +
                            '<button class="btn small warn" onclick="sendSysCmdTo(\'' + c.group + '\', \'shutdown\')">Off</button>' +
                            '</td>' +
                            '</tr>';
                    }).join('');
                });
        }
        function wakeDevice(mac) {
            authFetch('/api/wol', {
                method: 'POST', body: JSON.stringify({ mac: mac })
            }).then(function (r) { return r.json(); }).then(function (j) { alert(j.ok ? 'WOL Sent' : 'Failed'); });
        }
        function sendSysCmd(action) {
            if (!confirm('ç¢ºå®šè¦å°æ‰€æœ‰ç¾¤çµ„åŸ·è¡Œ ' + action + ' å—ï¼Ÿ')) return;
            sendCmd([1, 2, 3, 4, 5, 6], action, {});
        }
        function sendSysCmdTo(g, action) {
            if (!g) return;
            if (!confirm('ç¢ºå®šè¦å° Group ' + g + ' åŸ·è¡Œ ' + action + ' å—ï¼Ÿ')) return;
            sendTo(parseInt(g), action, {});
        }

        /* ====== Libraryï¼ˆåƒ… UPLOADS ç¾å­˜ï¼‰ ====== */
        function bytes(n) { if (!n && n !== 0) return 'â€”'; var u = ['B', 'KB', 'MB', 'GB']; var i = 0, v = n; while (v >= 1024 && i < u.length - 1) { v /= 1024; i++; } return (Math.round(v * 10) / 10) + ' ' + u[i]; }
        function guessType(url) { var u = (url || '').toLowerCase(); if (/\.(mp3|m4a|aac|wav|flac|ogg)$/.test(u)) return 'audio'; return 'video'; }
        function ellipsisName(name, max) { if (max === void 0) max = 42; name = String(name || ''); if (name.length <= max) return name; var keep = Math.floor(max / 2) - 2; return name.slice(0, keep) + 'â€¦' + name.slice(-keep); }
        function loadLib() {
            return authFetch('/api/uploads?only=av', { cache: 'no-store' })
                .then(function (r) { return r.json(); })
                .then(function (j) {
                    var items = (j && j.ok) ? (j.items || []) : [];
                    var options = '<option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>' + items.map(function (it) {
                        var label = (it.mtype === 'audio' ? 'éŸ³è¨Š' : 'å½±ç‰‡') + ' ' + ellipsisName(it.orig || it.saved || 'æª”æ¡ˆ') + 'ï¼ˆ' + (it.mtype || 'file') + 'ï½œ' + bytes(it.size) + 'ï¼‰';
                        return '<option value="' + it.url + '">' + label + '</option>';
                    }).join('');
                    var libCount = document.getElementById('libCount'); if (libCount) libCount.textContent = items.length || 0;
                    for (var g = 1; g <= GROUP_COUNT; g++) {
                        var sel = document.getElementById('g' + g + '-lib'); if (!sel) continue;
                        var prev = sel.value; sel.innerHTML = options;
                        var keepPrev = false; for (var i = 0; i < items.length; i++) { if (items[i].url === prev) { keepPrev = true; break; } }
                        sel.value = keepPrev ? prev : '';
                    }
                }).catch(function () { });
        }
        function reloadLib() { loadLib(); }

        /* ====== æ ¡æº–ä¼ºæœå™¨æ™‚é–“ ====== */
        var __svrOffset = 0; // server_now - client_nowï¼ˆç§’ï¼‰
        function serverNowSec() { return Math.floor(Date.now() / 1000 + __svrOffset); }
        function syncServerClock() {
            fetch('/health', { cache: 'no-store' })
                .then(function (r) { return r.json(); })
                .then(function (j) {
                    if (j && typeof j.ts === 'number') { __svrOffset = (j.ts - Date.now() / 1000); }
                }).catch(function () { });
        }
        function tickSrvClock() {
            var el = document.getElementById('srvClock'); if (!el) return;
            var t = new Date(serverNowSec() * 1000);
            var s = t.toLocaleTimeString('zh-TW', { hour12: false });
            el.textContent = s;
        }

        /* ====== å…±ç”¨å°å·¥å…· ====== */
        function currentUrlFor(g) { var sel = document.getElementById('g' + g + '-lib'); var url = (sel && sel.value) || ''; return url; }

        /* ====== Online ç¸®è¡¨ ====== */
        var onlineCache = { by_group: {}, now: 0 };
        function fmtPos(ct, dur) { function pad(n) { return String(Math.floor(n)).padStart(2, '0'); } function hhmmss(s) { return pad((s / 3600) | 0) + ':' + pad(((s % 3600) / 60) | 0) + ':' + pad(s % 60); } if (!ct && !dur) return 'â€”'; return hhmmss(ct || 0) + '/' + hhmmss(dur || 0); }
        function renderMiniOnline(g) {
            var host = document.getElementById('g' + g + '-online'); if (!host) return;
            var items = (onlineCache.by_group && onlineCache.by_group[String(g)]) || [];
            if (!items.length) { host.innerHTML = '<tr><td colspan="5" class="muted">ï¼ˆç„¡é€£ç·šï¼‰</td></tr>'; return; }
            host.innerHTML = items.map(function (e) {
                return '<tr>'
                    + '<td><span class="badge ' + (e.alive ? 'alive' : 'dead') + '">' + (e.alive ? 'åœ¨ç·š' : 'é›¢ç·š') + '</span></td>'
                    + '<td><code>' + (e.ip || '') + '</code></td>'
                    + '<td>' + (e.playing ? 'æ’­æ”¾ä¸­' : 'â€”') + '</td>'
                    + '<td>' + fmtPos(Number(e.ct || 0), Number(e.dur || 0)) + '</td>'
                    + '<td>' + (e.vol !== undefined ? (parseInt(e.vol, 10) + '%') : 'â€”') + '</td>'
                    + '</tr>';
            }).join('');
        }
        function refreshOnlineAll() {
            authFetch('/api/online', { cache: 'no-store' })
                .then(function (r) { return r.json(); })
                .then(function (j) { onlineCache.by_group = j.by_group || {}; onlineCache.now = j.now || 0; for (var g = 1; g <= GROUP_COUNT; g++) renderMiniOnline(g); })
                .catch(function () { });
        }

        /* ====== è¨Šæ¯ï¼ˆé›†ä¸­æ§åˆ¶ï¼‹å¡ç‰‡ç™½å­—è·‘é¦¬ç‡ˆé è¦½ï¼‰ ====== */
        var __msgTimers = {};
        function showCardMsg(g, text, durationSec) {
            var bar = document.getElementById('g' + g + '-msgBar');
            var msg = document.getElementById('g' + g + '-msg');
            if (!bar || !msg) return;
            if (!text) {
                bar.style.display = 'none'; msg.textContent = ''; msg.style.animation = '';
                if (__msgTimers[g]) { clearTimeout(__msgTimers[g]); __msgTimers[g] = null; }
                return;
            }
            bar.style.display = 'block'; msg.textContent = text;
            requestAnimationFrame(function () {
                var speed = 120, w = bar.clientWidth || 400, tw = msg.scrollWidth || (text.length * 16);
                var secs = (w + tw) / speed;
                msg.style.setProperty('--start', w + 'px');
                msg.style.setProperty('--end', (-tw) + 'px');
                msg.style.animation = 'marqueeVar ' + secs.toFixed(2) + 's linear infinite';
            });
            if (__msgTimers[g]) { clearTimeout(__msgTimers[g]); __msgTimers[g] = null; }
            if (durationSec && durationSec > 0) {
                __msgTimers[g] = setTimeout(function () { showCardMsg(g, '', 0); }, durationSec * 1000);
            }
        }
        window.addEventListener('resize', function () {
            for (var g = 1; g <= GROUP_COUNT; g++) {
                var bar = document.getElementById('g' + g + '-msgBar');
                var msg = document.getElementById('g' + g + '-msg');
                if (bar && msg && bar.style.display !== 'none' && msg.textContent) {
                    var text = msg.textContent, w = bar.clientWidth || 400, tw = msg.scrollWidth || (text.length * 16);
                    var speed = 120; var secs = (w + tw) / speed;
                    msg.style.setProperty('--start', w + 'px');
                    msg.style.setProperty('--end', (-tw) + 'px');
                    msg.style.animation = 'marqueeVar ' + secs.toFixed(2) + 's linear infinite';
                }
            }
        });
        function getSelectedMsgGroups() {
            var host = document.getElementById('msgGroups');
            var boxes = [].slice.call(host.querySelectorAll('.msgGroup'));
            var sel = boxes.filter(function (b) { return b.checked; }).map(function (b) { return parseInt(b.value, 10); }).filter(Boolean);
            return sel.length ? sel : Array.from({ length: GROUP_COUNT }, function (_, i) { return i + 1; });
        }
        function wireMessagePanel() {
            var host = document.getElementById('msgGroups');
            host.innerHTML = Array.from({ length: GROUP_COUNT }, (_, i) => i + 1).map(function (i) {
                return '<label><input type="checkbox" class="msgGroup" value="' + i + '" checked>çµ„' + i + '</label>';
            }).join('') + ' <button type="button" class="btn" id="msgSelAll">å…¨é¸</button> <button type="button" class="btn" id="msgSelNone">å…¨ä¸é¸</button> <button class="btn accent" id="btnMsgSend">ç™¼é€è¨Šæ¯</button> <button class="btn" id="btnMsgClear">æ¸…é™¤è¨Šæ¯</button>';

            document.getElementById('msgSelAll').addEventListener('click', () => { host.querySelectorAll('.msgGroup').forEach(b => b.checked = true); });
            document.getElementById('msgSelNone').addEventListener('click', () => { host.querySelectorAll('.msgGroup').forEach(b => b.checked = false); });

            document.getElementById('btnMsgSend').addEventListener('click', function () {
                var text = (document.getElementById('msgText').value || '').trim();
                var duration = Math.max(0, parseInt((document.getElementById('msgDuration').value || '0'), 10) || 0);
                if (!text) { alert('è«‹è¼¸å…¥è¨Šæ¯å…§å®¹'); return; }
                var groups = getSelectedMsgGroups();
                for (var i = 0; i < groups.length; i++) { showCardMsg(groups[i], text, duration); }
                sendCmd(groups, 'message', { text: text, duration: duration });
            });
            document.getElementById('btnMsgClear').addEventListener('click', function () {
                var groups = getSelectedMsgGroups();
                for (var i = 0; i < groups.length; i++) { showCardMsg(groups[i], '', 0); }
                sendCmd(groups, 'message_clear', {});
            });
        }

        /* ====== ç”Ÿæˆæ¯çµ„å¡ç‰‡ï¼ˆå«ï¼šå¡ç‰‡æ¨™é¡Œï¼†é ç´„ï¼‰ ====== */
        const SCHED = {}; // {g:{seq, jobs[], timers{}}}
        function schedInit(g) { if (!SCHED[g]) SCHED[g] = { seq: 1, jobs: [], timers: {} }; return SCHED[g]; }
        function fmtTime(ts) { var d = new Date(ts * 1000); return d.toLocaleString('zh-TW', { hour12: false }); }

        function makeGroupCard(g) {
            schedInit(g);
            var card = document.createElement('div'); card.className = 'card'; card.id = 'card-' + g; card.setAttribute('data-g', g);

            const savedTitle = localStorage.getItem('cardTitle_' + g) || ('çµ„ ' + g);
            card.innerHTML = ''
                + '<h3>'
                + '<span id="g' + g + '-title">' + savedTitle + '</span>'
                + '<span class="smallmuted" style="margin-left:auto">ä¼ºæœå™¨æ™‚é–“åŒæ­¥</span>'
                + '</h3>'

                + '<div class="row">'
                + '  <label>å¡ç‰‡æ¨™é¡Œ</label>'
                + '  <input id="g' + g + '-titleInput" class="input" placeholder="ä¾‹å¦‚ï¼šä¸‰å¹´ç”²ç­" style="flex:1">'
                + '  <button class="btn" id="g' + g + '-titleBtn">å¥—ç”¨</button>'
                + '</div>'

                + '<div class="row"><span class="badge" id="g' + g + '-status">â€”</span></div>'

                + '<div class="row">'
                + '  <div class="prev-wrap">'
                + '    <video id="g' + g + '-media" class="video-prev" controls muted playsinline preload="metadata"></video>'
                + '    <div class="msgBarCard" id="g' + g + '-msgBar"><div class="inner"><div class="marquee" id="g' + g + '-msg"></div></div></div>'
                + '  </div>'
                + '</div>'

                + '<div class="row">'
                + '  <div style="flex:1">'
                + '    <table class="mini-online">'
                + '      <thead><tr><th>ç‹€æ…‹</th><th>IP</th><th>æ’­æ”¾</th><th>ä½ç½®</th><th>éŸ³é‡</th></tr></thead>'
                + '      <tbody id="g' + g + '-online"><tr><td colspan="5" class="muted">ï¼ˆè®€å–ä¸­â€¦ï¼‰</td></tr></tbody>'
                + '    </table>'
                + '  </div>'
                + '</div>'

                + '<div class="row">'
                + '  <label>å¾æ¸…å–®é¸æ“‡</label>'
                + '  <select id="g' + g + '-lib" class="input" style="flex:1"></select>'
                + '  <button class="btn" id="g' + g + '-apply">å¥—ç”¨</button>'
                + '  <button class="btn" id="g' + g + '-reload">æ›´æ–°æ¸…å–®</button>'
                + '</div>'

                + '<div class="row">'
                + '  <input id="g' + g + '-file" type="file" accept="audio/*,video/*">'
                + '  <button class="btn" id="g' + g + '-upload">ä¸Šå‚³</button>'
                + '</div>'

                + '<div class="row">'
                + '  <button class="btn" id="g' + g + '-play">æ’­æ”¾</button>'
                + '  <button class="btn" id="g' + g + '-pause">æš«åœ</button>'
                + '  <button class="btn" id="g' + g + '-stop">åœæ­¢</button>'
                + '  <button class="btn" id="g' + g + '-close">é—œé–‰æœ¬çµ„è¦–çª—</button>'
                + '  <button class="btn" id="g' + g + '-lock">é–å®šæ§åˆ¶</button>'
                + '  <button class="btn" id="g' + g + '-unlock">è§£é™¤æ§åˆ¶</button>'
                + '</div>'

                + '<div class="row">'
                + '  <label>éŸ³é‡</label>'
                + '  <input id="g' + g + '-vol" class="input" type="range" min="0" max="100" value="100" style="flex:1">'
                + '  <span class="mono" id="g' + g + '-volShow">100%</span>'
                + '</div>'

                + '<div class="row">'
                + '  <input id="g' + g + '-msgText" class="input" placeholder="æœ¬çµ„è¨Šæ¯â€¦" style="flex:1">'
                + '  <input id="g' + g + '-msgSec" class="input" type="number" min="0" step="1" value="10" style="width:88px">'
                + '  <button class="btn" id="g' + g + '-msgSend">ç™¼é€</button>'
                + '  <button class="btn" id="g' + g + '-msgClear">æ¸…é™¤</button>'
                + '</div>'

                /* === æ¯å¡ç‰‡ï¼šé ç´„ === */
                + '<div class="row" style="margin-top:8px"><div class="smallmuted">é ç´„ï¼ˆæ­¤å¡ç‰‡å°ˆç”¨ï¼‰</div></div>'
                + '<div class="row">'
                + '  <label>æ™‚é–“</label>'
                + '  <input id="g' + g + '-schedAt" class="input" type="datetime-local" style="width:220px">'
                + '  <label style="margin-left:8px">ä¾†æº</label>'
                + '  <select id="g' + g + '-schedLib" class="input" style="flex:1"><option value="">ï¼ˆä½¿ç”¨ä¸Šæ–¹ã€Œå¾æ¸…å–®é¸æ“‡ã€ï¼‰</option></select>'
                + '</div>'
                + '<div class="row">'
                + '  <label>èµ·é»</label>'
                + '  <select id="g' + g + '-seekMode" class="input">'
                + '    <option value="zero">å¾é ­ï¼ˆseek=0ï¼‰</option>'
                + '    <option value="preview">ä¾æœ¬å¡é è¦½æ™‚é–“</option>'
                + '  </select>'
                + '  <label style="margin-left:8px">é€Ÿåº¦</label>'
                + '  <input id="g' + g + '-schedSpeed" class="input" type="number" step="0.1" min="0.25" max="4" value="1.0" style="width:90px">'
                + '  <label style="margin-left:8px">å®¹å·®(ms)</label>'
                + '  <input id="g' + g + '-schedTol" class="input" type="number" step="50" min="100" value="400" style="width:90px">'
                + '</div>'
                + '<div class="row">'
                + '  <button class="btn accent" id="g' + g + '-makePlay">å»ºç«‹ã€Œé ç´„æ’­æ”¾ã€</button>'
                + '  <input id="g' + g + '-schedMsgText" class="input" placeholder="åŒæ­¥é¡¯ç¤ºçš„è¨Šæ¯â€¦" style="flex:1;margin-left:8px">'
                + '  <input id="g' + g + '-schedMsgSec" class="input" type="number" min="0" step="1" value="10" style="width:88px">'
                + '  <button class="btn" id="g' + g + '-makeMsg">å»ºç«‹ã€Œé ç´„è¨Šæ¯ã€</button>'
                + '</div>'
                + '<div class="row">'
                + '  <table class="sched-list" id="g' + g + '-schedTable">'
                + '    <thead><tr><th>#</th><th>æ™‚é–“</th><th>é¡å‹</th><th>å…§å®¹/åª’é«”</th><th>å‚™è¨»</th><th></th></tr></thead>'
                + '    <tbody><tr><td colspan="6" class="muted">ï¼ˆå°šç„¡é ç´„ï¼‰</td></tr></tbody>'
                + '  </table>'
                + '</div>';

            return card;
        }

        function buildUI() {
            var grid = document.getElementById('groupsGrid'); grid.innerHTML = '';
            // é›†ä¸­è¨Šæ¯ç¾¤çµ„å‹¾é¸
            var msgHost = document.getElementById('msgGroups');
            msgHost.innerHTML = Array.from({ length: GROUP_COUNT }, (_, i) => i + 1).map(i => (
                '<label><input type="checkbox" class="msgGroup" value="' + i + '" checked>çµ„' + i + '</label>'
            )).join('') + ' <button type="button" class="btn" id="msgSelAll">å…¨é¸</button> <button type="button" class="btn" id="msgSelNone">å…¨ä¸é¸</button>';

            for (var g = 1; g <= GROUP_COUNT; g++) {
                grid.appendChild(makeGroupCard(g));
                installSeekToSync(g);
                wireCard(g);
            }
        }

        /* ====== å¡ç‰‡äº‹ä»¶ç¶å®š ====== */
        function installSeekToSync(g) {
            var v = document.getElementById('g' + g + '-media');
            if (!v) return;
            v.addEventListener('seeked', function () { pushSyncPlay(g); });
            v.addEventListener('ratechange', function () { sendTo(g, 'set_speed', { speed: Math.max(0.25, Math.min(4, v.playbackRate || 1)) }); });
            v.addEventListener('volumechange', function () {
                var vol = Math.max(0, Math.min(1, v.volume || 1));
                var range = document.getElementById('g' + g + '-vol'); var show = document.getElementById('g' + g + '-volShow');
                if (range) { range.value = Math.round(vol * 100); }
                if (show) { show.textContent = Math.round(vol * 100) + '%'; }
                sendTo(g, 'set_volume', { volume: vol });
            });
        }
        function pushSyncPlay(g) {
            var v = document.getElementById('g' + g + '-media');
            var url = currentUrlFor(g); if (!url || !v) return;
            var type = guessType(url);
            var speed = Math.max(0.25, Math.min(4, v.playbackRate || 1));
            var seek_to = Math.max(0, Number(v.currentTime || 0));
            var at_ts = serverNowSec() + 1;
            sendTo(g, 'sync_play', { url: url, type: type, seek_to: seek_to, speed: speed, at_ts: at_ts, tolerance_ms: 400 });
        }

        function wireCard(g) {
            // æ¨™é¡Œï¼ˆ*å¥—ç”¨æ™‚åŒæ­¥åˆ°å­¸ç”Ÿç«¯ï¼‰
            const tSpan = document.getElementById('g' + g + '-title');
            const tIpt = document.getElementById('g' + g + '-titleInput');
            const tBtn = document.getElementById('g' + g + '-titleBtn');
            tIpt.value = tSpan.textContent || ('çµ„ ' + g);
            tBtn.addEventListener('click', () => {
                const v = (tIpt.value || '').trim() || ('çµ„ ' + g);
                tSpan.textContent = v;
                localStorage.setItem('cardTitle_' + g, v);
                sendTo(g, 'set_title', { title: v }); // <- åŒæ­¥çµ¦å­¸ç”Ÿç«¯
            });

            // æ¸…å–®ï¼†ä¸Šå‚³
            document.getElementById('g' + g + '-apply').addEventListener('click', () => applyFromLib(g));
            document.getElementById('g' + g + '-reload').addEventListener('click', reloadLib);
            document.getElementById('g' + g + '-upload').addEventListener('click', () => uploadFile(g));

            // æ’­æ§
            document.getElementById('g' + g + '-play').addEventListener('click', () => playLocal(g));
            document.getElementById('g' + g + '-pause').addEventListener('click', () => pauseGroup(g));
            document.getElementById('g' + g + '-stop').addEventListener('click', () => stopGroup(g));
            document.getElementById('g' + g + '-close').addEventListener('click', () => sendTo(g, 'close_window', {}));
            document.getElementById('g' + g + '-lock').addEventListener('click', () => sendTo(g, 'controls_lock', { on: true }));
            document.getElementById('g' + g + '-unlock').addEventListener('click', () => sendTo(g, 'controls_lock', { on: false }));

            // éŸ³é‡
            const volRange = document.getElementById('g' + g + '-vol');
            const volShow = document.getElementById('g' + g + '-volShow');
            volRange.addEventListener('input', () => { const v = parseInt(volRange.value || '100', 10) || 100; volShow.textContent = v + '%'; });
            volRange.addEventListener('change', () => { const v = Math.max(0, Math.min(1, (parseInt(volRange.value || '100', 10) || 100) / 100)); try { document.getElementById('g' + g + '-media').volume = v; } catch (e) { } sendTo(g, 'set_volume', { volume: v }); });

            // è¨Šæ¯
            document.getElementById('g' + g + '-msgSend').addEventListener('click', () => {
                var txt = (document.getElementById('g' + g + '-msgText').value || '').trim();
                var sec = Math.max(0, parseInt((document.getElementById('g' + g + '-msgSec').value || '0'), 10) || 0);
                if (!txt) { alert('çµ„ ' + g + 'ï¼šè«‹è¼¸å…¥è¨Šæ¯'); return; }
                showCardMsg(g, txt, sec);
                sendTo(g, 'message', { text: txt, duration: sec });
            });
            document.getElementById('g' + g + '-msgClear').addEventListener('click', () => {
                showCardMsg(g, '', 0);
                sendTo(g, 'message_clear', {});
            });

            // é ç´„ï¼ˆæ­¤å¡ï¼‰
            const schedLibSel = document.getElementById('g' + g + '-schedLib');
            schedLibSel.innerHTML = '<option value="">ï¼ˆä½¿ç”¨ä¸Šæ–¹ã€Œå¾æ¸…å–®é¸æ“‡ã€ï¼‰</option>';

            const tblBody = document.querySelector('#g' + g + '-schedTable tbody');
            function render() {
                const S = schedInit(g);
                if (!S.jobs.length) { tblBody.innerHTML = '<tr><td colspan="6" class="muted">ï¼ˆå°šç„¡é ç´„ï¼‰</td></tr>'; return; }
                tblBody.innerHTML = S.jobs.map(function (j) {
                    return '<tr>'
                        + '<td class="mono">' + j.id + '</td>'
                        + '<td class="mono">' + fmtTime(j.at) + '</td>'
                        + '<td>' + (j.kind === 'play' ? 'æ’­æ”¾' : 'è¨Šæ¯') + '</td>'
                        + '<td>' + (j.kind === 'play' ? (j.media || '(å„çµ„æ¸…å–®)') : (j.text || '')) + '</td>'
                        + '<td>' + (j.kind === 'play' ? ('seek:' + j.seekMode + '/speed:' + j.speed) : ('sec:' + (j.duration || 0))) + '</td>'
                        + '<td><button class="btn" onclick="(function(){cancelJob(' + g + ',' + j.id + ');})();">å–æ¶ˆ</button></td>'
                        + '</tr>';
                }).join('');
            }
            window.cancelJob = function (gg, id) {
                const S = schedInit(gg);
                const i = S.jobs.findIndex(x => x.id === id);
                if (i >= 0) S.jobs.splice(i, 1);
                if (S.timers[id]) { clearTimeout(S.timers[id]); delete S.timers[id]; }
                if (gg === g) render();
            }
            function atFromInput() {
                const val = document.getElementById('g' + g + '-schedAt').value;
                if (!val) return null;
                const ms = Date.parse(val);
                if (isNaN(ms)) return null;
                return Math.floor(ms / 1000);
            }
            document.getElementById('g' + g + '-makePlay').addEventListener('click', function () {
                const at = atFromInput(); if (!at) { alert('è«‹é¸æ“‡é ç´„æ™‚é–“'); return; }
                const S = schedInit(g);
                const media = (document.getElementById('g' + g + '-schedLib').value || '') || currentUrlFor(g);
                if (!media) { alert('è«‹å…ˆé¸æ“‡ä¾†æº'); return; }
                const seekMode = (document.getElementById('g' + g + '-seekMode').value || 'zero');
                const speed = Math.max(0.25, Math.min(4, parseFloat(document.getElementById('g' + g + '-schedSpeed').value || '1') || 1));
                const tol = Math.max(100, parseInt(document.getElementById('g' + g + '-schedTol').value || '400', 10) || 400);

                const id = S.seq++;
                S.jobs.push({ id, kind: 'play', at, media, seekMode, speed, tol });
                S.timers[id] = setTimeout(function () {
                    const url = media, type = guessType(url);
                    let seek = 0; if (seekMode === 'preview') { try { const v = document.getElementById('g' + g + '-media'); seek = Math.max(0, Number(v.currentTime || 0)); } catch (e) { } }
                    const at_ts = at + 1; // ç·©è¡1ç§’
                    sendTo(g, 'set_media', { type: type, url: url });
                    sendTo(g, 'set_speed', { speed: speed });
                    sendTo(g, 'sync_play', { url: url, type: type, seek_to: seek, speed: speed, at_ts: at_ts, tolerance_ms: tol });
                    cancelJob(g, id);
                }, Math.max(0, Math.floor((at - serverNowSec()) * 1000)));
                render();
            });
            document.getElementById('g' + g + '-makeMsg').addEventListener('click', function () {
                const at = atFromInput(); if (!at) { alert('è«‹é¸æ“‡é ç´„æ™‚é–“'); return; }
                const S = schedInit(g);
                const text = (document.getElementById('g' + g + '-schedMsgText').value || '').trim();
                const duration = Math.max(0, parseInt((document.getElementById('g' + g + '-schedMsgSec').value || '0'), 10) || 0);
                if (!text) { alert('è«‹è¼¸å…¥è¨Šæ¯å…§å®¹'); return; }
                const id = S.seq++;
                S.jobs.push({ id, kind: 'msg', at, text, duration });
                S.timers[id] = setTimeout(function () {
                    sendTo(g, 'message', { text: text, duration: duration });
                    cancelJob(g, id);
                }, Math.max(0, Math.floor((at - serverNowSec()) * 1000)));
                render();
            });

            render();
        }

        /* ====== åª’é«”èˆ‡æ§åˆ¶ï¼ˆå…±ç”¨ï¼‰ ====== */
        function applyFromLib(g) {
            var sel = document.getElementById('g' + g + '-lib');
            if (sel && sel.value) { var el = document.getElementById('g' + g + '-media'); el.src = sel.value; el.currentTime = 0; }
        }
        function uploadFile(g) {
            var inp = document.getElementById('g' + g + '-file');
            if (!inp.files || !inp.files.length) { alert('è«‹é¸æ“‡æª”æ¡ˆ'); return; }
            var fd = new FormData(); fd.append('file', inp.files[0]);
            authFetch('/api/upload', { method: 'POST', body: fd })
                .then(function (r) { return r.json(); })
                .then(function (j) {
                    if (!j.ok) { alert(j.error || 'ä¸Šå‚³å¤±æ•—'); return; }
                    var el = document.getElementById('g' + g + '-media'); el.src = j.url; el.currentTime = 0; reloadLib();
                }).catch(function () { alert('ä¸Šå‚³å¤±æ•—'); });
        }
        function playLocal(g) {
            var el = document.getElementById('g' + g + '-media');
            var url = currentUrlFor(g);
            if (!url) { alert('çµ„ ' + g + 'ï¼šè«‹å…ˆå¾æ¸…å–®é¸æ“‡æˆ–ä¸Šå‚³'); return; }
            try { var p = el.play(); if (p && p.catch) { p.catch(function () { }); } } catch (e) { }
            var type = guessType(url);
            var speed = Math.max(0.25, Math.min(4, el.playbackRate || 1));
            var seek = Math.max(0, Number(el.currentTime || 0));
            sendTo(g, 'set_media', { type: type, url: url });
            sendTo(g, 'set_speed', { speed: speed });
            var at_ts = serverNowSec() + 1;
            sendTo(g, 'sync_play', { url: url, type: type, seek_to: seek, speed: speed, at_ts: at_ts, tolerance_ms: 400 });
        }
        function pauseGroup(g) { try { document.getElementById('g' + g + '-media').pause(); } catch (e) { } sendTo(g, 'pause', {}); }
        function stopGroup(g) { try { var el = document.getElementById('g' + g + '-media'); el.pause(); el.currentTime = 0; } catch (e) { } sendTo(g, 'stop', {}); }

        /* ====== Client State Management (Ported from silent-dashboard) ====== */
        let clientState = { clients: {}, selectedIds: new Set(), auto: true };

        function toggleAll(checkbox) {
            const checked = checkbox.checked;
            document.querySelectorAll('input[name="targets"]').forEach(cb => {
                cb.checked = checked;
                checked ? clientState.selectedIds.add(cb.value) : clientState.selectedIds.delete(cb.value);
            });
        }

        function handleCheckbox(cb) {
            cb.checked ? clientState.selectedIds.add(cb.value) : clientState.selectedIds.delete(cb.value);
            const total = Object.keys(clientState.clients).length;
            const selected = clientState.selectedIds.size;
            const chkAll = document.getElementById("chkAll");
            if (chkAll) {
                chkAll.checked = selected > 0 && selected === total;
                chkAll.indeterminate = selected > 0 && selected < total;
            }
        }

        async function refreshClients() {
            try {
                const resp = await authFetch('/controller/api/clients');
                const data = await resp.json();
                if (!data.ok) return;

                clientState.clients = data.clients || {};
                const onlineCount = data.online_count || 0;

                const sumOnline = document.getElementById("summaryOnline");
                const sumTotal = document.getElementById("summaryTotal");
                if (sumOnline) sumOnline.textContent = onlineCount;
                if (sumTotal) sumTotal.textContent = Object.keys(clientState.clients).length;

                renderClients();
            } catch (e) {
                console.warn("Refresh clients failed", e);
            }
        }

        function renderClients() {
            const body = document.getElementById("clientBody");
            if (!body) return;

            const entries = Object.entries(clientState.clients || {}).sort((a, b) => a[0].localeCompare(b[0]));
            if (entries.length === 0) {
                body.innerHTML = '<tr><td colspan="6" class="muted" style="text-align:center; padding:12px;">æš«ç„¡é€£ç·šè¨­å‚™</td></tr>';
                return;
            }

            let html = '';
            for (const [cid, c] of entries) {
                const isOnline = c.online;
                const statusBadge = isOnline ?
                    '<span class="badge alive" style="margin:0">ç·šä¸Š</span>' :
                    '<span class="badge dead" style="margin:0">é›¢ç·š</span>';

                const isChecked = clientState.selectedIds.has(cid) ? 'checked' : '';

                html += `<tr>
                    <td style="text-align:center;">
                        <input type="checkbox" name="targets" value="${cid}" ${isChecked} onchange="handleCheckbox(this)">
                    </td>
                    <td class="mono">${cid}</td>
                    <td>${c.hostname || '--'}</td>
                    <td class="mono">${c.ip || '--'}</td>
                    <td>${statusBadge}</td>
                    <td style="text-align:right;">
                        <button class="btn small warn" onclick="sendToOne('${cid}', 'shutdown', {})" title="é—œæ©Ÿ">â»</button>
                    </td>
                </tr>`;
            }
            body.innerHTML = html;
        }

        // å–®ç™¼æŒ‡ä»¤ wrapper
        function sendToOne(targetId, action, payload) {
            if (!confirm(`ç¢ºå®šè¦å° ${targetId} åŸ·è¡Œ ${action}ï¼Ÿ`)) return;
            // é€™è£¡å€Ÿç”¨ controller API (é›–ç„¶å–®æ©Ÿæ“ä½œä¹Ÿå¯ä»¥ç”¨èˆŠçš„ï¼Œä½† controller API æ¯”è¼ƒä¸€è‡´)
            authFetch('/controller/api/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targets: [targetId], cmd: action, url: "" })
            }).then(r => r.json()).then(j => {
                if (j.ok) alert("å·²ç™¼é€");
                else alert("ç™¼é€å¤±æ•—: " + j.error);
            });
        }

        async function quickCmd(cmd) {
            const targets = Array.from(clientState.selectedIds);
            const statusEl = document.getElementById("quickStatus");
            if (targets.length === 0) {
                if (statusEl) statusEl.textContent = "âš ï¸ è«‹å…ˆå‹¾é¸è‡³å°‘ä¸€å°å­¸ç”Ÿç«¯";
                return;
            }

            if (statusEl) statusEl.textContent = "ç™¼é€ä¸­...";
            try {
                const resp = await authFetch('/controller/api/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targets, cmd, url: "" })
                });
                const r = await resp.json();
                if (statusEl) statusEl.textContent = r.ok ? `âœ… å·²ç™¼é€æŒ‡ä»¤ï¼š${cmd}` : `âŒ å¤±æ•—ï¼š${r.error}`;
            } catch (e) {
                if (statusEl) statusEl.textContent = "âŒ ç™¼é€å¤±æ•—";
            }
        }

        async function quickOpenGroup(groupId) {
            const targets = Array.from(clientState.selectedIds);
            const statusEl = document.getElementById("quickStatus");
            if (targets.length === 0) {
                if (statusEl) statusEl.textContent = "âš ï¸ è«‹å…ˆå‹¾é¸è‡³å°‘ä¸€å°å­¸ç”Ÿç«¯";
                return;
            }

            const url = `${window.location.origin}/g/${groupId}`;
            if (statusEl) statusEl.textContent = `ç™¼é€ä¸­ï¼ˆç¾¤çµ„ ${groupId}ï¼‰...`;

            try {
                const resp = await authFetch('/controller/api/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targets, cmd: "open_url", url })
                });
                const r = await resp.json();
                if (statusEl) statusEl.textContent = r.ok ? `âœ… å·²å° ${r.count || targets.length} å°é–‹å•Ÿ /g/${groupId}` : `âŒ å¤±æ•—ï¼š${r.error}`;
            } catch (e) {
                if (statusEl) statusEl.textContent = "âŒ ç™¼é€å¤±æ•—";
            }
        }

        async function quickOpenUrl(isSilentBroadcast = false) {
            const targets = Array.from(clientState.selectedIds);
            const statusEl = document.getElementById("quickStatus");
            if (targets.length === 0) {
                if (statusEl) statusEl.textContent = "âš ï¸ è«‹å…ˆå‹¾é¸è‡³å°‘ä¸€å°";
                return;
            }
            let url = "";
            if (isSilentBroadcast) {
                url = window.location.origin + "/static/ui/announce.html";
            }
            if (statusEl) statusEl.textContent = "é–‹å•Ÿä¸­...";
            try {
                const resp = await authFetch('/controller/api/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targets, cmd: "open_url", url })
                });
                const r = await resp.json();
                if (statusEl) statusEl.textContent = r.ok ? `âœ… å·²é–‹å•ŸéœéŸ³å»£æ’­é ` : `âŒ å¤±æ•—`;
            } catch (e) {
                if (statusEl) statusEl.textContent = "âŒ å¤±æ•—";
            }
        }

        /* ====== å•Ÿå‹• ====== */
        async function init() {
            await ensureLoggedIn();
            syncServerClock();
            setInterval(syncServerClock, 60 * 1000);
            setInterval(tickSrvClock, 500);

            buildUI();
            reloadLib();
            // Start mini dashboard refresh
            refreshClients();
            setInterval(refreshClients, 5000);

            refreshOnlineAll();
            setInterval(refreshOnlineAll, 2000);

            // å…¨åŸŸæŒ‰éˆ•ï¼ˆè‹¥æœ‰é¡¯ç¤ºæ‰ç¶å®šï¼‰
            const btnReload = document.getElementById('btnReloadLib');
            if (btnReload) btnReload.addEventListener('click', reloadLib);

            const btnLockAll = document.getElementById('btnLockAll');
            if (btnLockAll) {
                btnLockAll.addEventListener('click', function () {
                    sendCmd(Array.from({ length: GROUP_COUNT }, (_, i) => i + 1), 'controls_lock', { on: true });
                });
            }

            const btnUnlockAll = document.getElementById('btnUnlockAll');
            if (btnUnlockAll) {
                btnUnlockAll.addEventListener('click', function () {
                    sendCmd(Array.from({ length: GROUP_COUNT }, (_, i) => i + 1), 'controls_lock', { on: false });
                });
            }

            const btnCloseAll = document.getElementById('btnCloseAll');
            if (btnCloseAll) {
                btnCloseAll.addEventListener('click', function () {
                    sendCmd(Array.from({ length: GROUP_COUNT }, (_, i) => i + 1), 'close_window', {});
                });
            }

            wireMessagePanel();
        }
        function startApp() {
            init().catch(err => console.error(err));
        }
        if (document.readyState === 'loading') {
            window.addEventListener('DOMContentLoaded', startApp);
        } else {
            startApp();
        }
    </script>

    <!-- QR å¿«æ·éˆ•ï¼ˆå³ä¸Šè§’æµ®å‹•ï¼‰ -->
    <button id="qrFloatBtn" onclick="window.open('/qr?src=auto','_blank')">QR Code</button>

</body>

</html>